# Issues 539, 541, 545 Implementation Plan

## Summary

Create CI infrastructure for 4-platform build essentials testing, plus make recipe (homebrew_bottle) and gdbm recipe (source build via configure_make) to validate the complete source compilation pipeline.

## Approach

This implements Phase 2 of the dependency provisioning design:
1. **#539 (CI)**: Establishes the 4-platform test matrix
2. **#541 (make)**: Provides GNU Make via homebrew_bottle
3. **#545 (gdbm)**: Validates configure_make by building from source

gdbm is ideal because it has no library dependencies - just needs make. This cleanly validates the source build pipeline.

### Alternatives Considered

- **zlib/expat approach**: Would validate library dependencies but doesn't test source builds. Deferred to separate issue.
- **Using system make for gdbm**: Defeats the purpose of validating tsuku-provided make.

## Files to Create

- `.github/workflows/build-essentials.yml` - 4-platform test matrix for build essentials
- `internal/recipe/recipes/m/make.toml` - make recipe using homebrew_bottle
- `internal/recipe/recipes/g/gdbm.toml` - gdbm recipe using homebrew_source + configure_make

## Files to Modify

- `internal/recipe/validator.go` - Add homebrew_source and configure_make to known actions

## Implementation Steps

- [x] Add homebrew_source and configure_make to validator knownActions
- [x] Add parameter validation for new actions
- [x] Create make.toml recipe using homebrew_bottle
- [x] Create gdbm.toml recipe with homebrew_source + configure_make
- [x] Create build-essentials.yml CI workflow with 4-platform matrix
- [x] Run local tests to verify recipes work
- [ ] Verify CI workflow syntax with actionlint

Mark each step [x] after it is implemented and committed.

## Testing Strategy

### Local Testing
- `go test ./...` - Ensure no regressions
- `./tsuku install make` - Verify make installs
- `make --version` - Verify make works
- `./tsuku install gdbm` - Verify gdbm builds from source
- `gdbmtool --version` - Verify gdbm binary works

### CI Testing
- Workflow runs on ubuntu-latest, ubuntu-24.04-arm, macos-13, macos-14
- Each platform installs make and builds gdbm from source
- Validates `gdbmtool --version` works

## Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| arm64 Linux runner availability | ubuntu-24.04-arm is available in GitHub Actions |
| configure_make requires system compiler | Use zig cc wrapper (already in buildAutotoolsEnv) |
| gdbm configure fails on some platforms | Test locally on Linux before pushing |

## Success Criteria

- [ ] make recipe installs on all 4 platforms
- [ ] `make --version` shows GNU Make
- [ ] gdbm recipe builds from source on all 4 platforms
- [ ] `gdbmtool --version` works from tsuku bin
- [ ] CI workflow runs on ubuntu-latest, ubuntu-24.04-arm, macos-13, macos-14
- [ ] All CI jobs pass

## Open Questions

1. Does gdbm require any configure flags for cross-platform compatibility?
2. Does the zig cc wrapper work for gdbm compilation or do we need system gcc?
