# Issue 583, 586, 587 Implementation Plan

## Summary

Remove Homebrew source build infrastructure: convert test fixtures to primitives, delete the `homebrew_source` action, and remove source build code from HomebrewBuilder.

## Approach

Execute in dependency order: convert fixtures first so `homebrew_source` has no users, then delete the action, then remove builder code. This ensures each step leaves the codebase in a working state.

### Alternatives Considered
- **Incremental PRs**: Separate PRs for each issue. Rejected because the changes are tightly coupled and the intermediate states add no value.
- **Bottom-up removal**: Remove builder code first. Rejected because it would break tests that still use `homebrew_source`.

## Files to Modify

### Step 1: Convert test fixtures (#583)
- `testdata/recipes/bash-source.toml` - replace `homebrew_source` with `download_file` + `extract`
- `testdata/recipes/python-source.toml` - replace `homebrew_source` with `download_file` + `extract`
- `testdata/recipes/readline-source.toml` - replace `homebrew_source` with `download_file` + `extract`
- `internal/builders/llm-test-matrix.json` - update action field from `homebrew_source` to `download_file`

### Step 2: Remove homebrew_source action (#586)
- `internal/actions/homebrew_source.go` - DELETE (216 lines)
- `internal/actions/homebrew_source_test.go` - DELETE (277 lines)
- `internal/actions/action.go` - remove registration (line 154)
- `internal/actions/action_test.go` - remove from test list (line 131)
- `internal/actions/decomposable_test.go` - remove from test list (line 16)
- `internal/recipe/validator.go` - update to reject `homebrew_source` (lines 244, 354-356)

### Step 3: Remove HomebrewBuilder source code (#587)
- `internal/builders/homebrew.go` - remove source build code (~1,000+ lines):
  - `ToolFetchFormulaRuby` constant
  - `ToolExtractSourceRecipe` constant
  - `lastSourceData` field
  - `sourceRecipeData` struct
  - `validateSourceRecipeData()` function
  - `generateSourceRecipeOutput()` method
  - `buildSourceSteps()` method
  - Source-related tool definitions and handlers
  - Source-related session state handling
- `internal/builders/homebrew_test.go` - remove source build tests

## Implementation Steps

- [x] 1. Fetch source URLs and checksums from Homebrew API for bash, python@3.13, readline
- [x] 2. Convert bash-source.toml to primitives (download_file + extract)
- [x] 3. Convert python-source.toml to primitives
- [x] 4. Convert readline-source.toml to primitives
- [x] 5. Update llm-test-matrix.json
- [x] 6. Run tests to verify fixtures work
- [x] 7. Delete homebrew_source.go and homebrew_source_test.go
- [x] 8. Remove homebrew_source from action registry
- [x] 9. Remove from action_test.go and decomposable_test.go
- [x] 10. Update validator.go to reject homebrew_source
- [x] 11. Run tests to verify action removal
- [x] 12. Remove source build code from homebrew.go
- [x] 13. Remove source build tests from homebrew_test.go
- [x] 14. Run full test suite and verify build

## Testing Strategy

- Unit tests: Existing tests should pass after each step
- Integration: Run `go test ./...` after each major step
- Build verification: `go build ./cmd/tsuku` after each step
- Lint: `go vet ./...` before final commit

## Risks and Mitigations

- **Fixture conversion breaks tests**: Mitigated by fetching actual URLs/checksums from Homebrew API
- **Missing source code references**: Mitigated by thorough grep search before removal
- **Breaking HomebrewBuilder bottle functionality**: Mitigated by running full test suite

## Success Criteria

- [x] All three test fixtures converted to primitives
- [x] `homebrew_source` action completely removed
- [x] HomebrewBuilder source code removed (~1,200 lines)
- [x] All tests pass
- [x] `go build ./...` succeeds
- [x] `go vet ./...` passes
- [x] No references to `homebrew_source` remain (except design docs)

## Open Questions

None - scope is clear from design doc and issue descriptions.
