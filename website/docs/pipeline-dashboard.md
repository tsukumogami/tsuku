# Pipeline Dashboard Documentation

## Overview

The pipeline dashboard provides visibility into the batch recipe generation pipeline. It helps operators debug failures, track pipeline health, and manage curated overrides through an interconnected set of pages.

**Dashboard URL**: `/pipeline/` (relative to website root)

**Purpose**: Help operators and maintainers:
- Monitor pipeline health via circuit breaker states
- Investigate failure patterns and drill down to individual packages
- Track batch run history and success rates
- Manage curated override validation status
- Identify blocking dependencies in the queue

## Page Inventory

The dashboard consists of an index page, several list pages, and detail pages. Pages link to each other through cross-references.

### Index (`/pipeline/`)

The main dashboard shows an at-a-glance summary of the pipeline:

- **Pipeline Health**: Circuit breaker state per ecosystem (healthy/degraded/open), last run and last successful run timestamps, runs since last success, warning if no run in >2 hours
- **Queue Status**: Counts for pending, success, failed, and blocked packages
- **Top Blockers**: Dependencies blocking the most packages
- **Recent Failures**: Last 5 failures with relative timestamps
- **Failure Categories**: Breakdown by category with subcategory detail
- **Recent Runs**: Last batch runs with ecosystem, success rate, and duration
- **Curated Overrides**: Total, valid, and invalid override counts
- **Disambiguations**: Summary of packages needing disambiguation

### List Pages

| Page | URL | Description |
|------|-----|-------------|
| Failures | `/pipeline/failures.html` | All failure records with category/subcategory/ecosystem filters |
| Runs | `/pipeline/runs.html` | Batch run history with ecosystem/status filters and 24h/7d stats |
| Pending | `/pipeline/pending.html` | Packages waiting for processing, with search and ecosystem filters |
| Blocked | `/pipeline/blocked.html` | Packages blocked by dependencies, with blocker analysis panel |
| Success | `/pipeline/success.html` | Successfully processed packages with timeline chart |
| Disambiguations | `/pipeline/disambiguations.html` | Packages needing name disambiguation |
| Curated | `/pipeline/curated.html` | Curated overrides with validation status badges |

### Detail Pages

| Page | URL Pattern | Description |
|------|-------------|-------------|
| Failure Detail | `/pipeline/failure.html?id=<id>` | Single failure with full context, message, and cross-links |
| Run Detail | `/pipeline/run.html?id=<batch_id>` | Single batch run with packages processed and failure list |
| Package Detail | `/pipeline/package.html?id=<ecosystem:name>` | Package history across queue, failures, disambiguations |

## Navigation Flow

The typical investigation flow follows a panel-to-list-to-detail pattern:

```
Index panel → List page (filtered) → Detail page → Cross-linked detail
```

**Example: Investigating a failure**
1. See "Recent Failures" panel on index showing `ffmpeg` failed
2. Click to go to failures list, filtered by category
3. Click a specific failure to see the detail page
4. From detail, click the package name to see full package history
5. From detail, click the batch ID to see what else failed in that run

**Example: Checking pipeline health**
1. See "Pipeline Health" panel showing homebrew is "degraded"
2. Click last run link to see the run detail
3. See which packages failed in that run
4. Click through to failure details for root cause

## URL Parameters

All list pages support URL parameters for filtering and deep linking. Filters sync with the URL via `history.pushState`, so you can share filtered views.

| Page | Parameters |
|------|------------|
| Failures | `?category=`, `?subcategory=`, `?ecosystem=`, `?batch_id=` |
| Runs | `?ecosystem=`, `?status=` |
| Pending | `?ecosystem=`, `?priority=`, `?search=` |
| Blocked | `?blocker=` |
| Success | `?ecosystem=`, `?range=` |
| Disambiguations | `?status=`, `?reason=` |
| Curated | `?status=` |

## Data Source

### dashboard.json

All pages load data from a single file: `/pipeline/dashboard.json`. This file is generated by the `queue-analytics` command and contains all the data needed for the dashboard.

**Regeneration Command**:
```bash
go run cmd/queue-analytics/main.go \
  --queue data/pipeline/priority-queue.json \
  --failures data/pipeline/failures/ \
  --metrics data/pipeline/metrics/ \
  --disambiguations data/pipeline/disambiguations.json \
  --control data/pipeline/batch-control.json \
  --output website/pipeline/dashboard.json
```

**Top-level sections in dashboard.json**:

| Section | Source | Description |
|---------|--------|-------------|
| `queue` | priority-queue.json | Package counts and lists by status |
| `health` | batch-control.json + metrics | Circuit breaker state, run tracking |
| `failure_details` | failures/*.jsonl | Individual failure records (capped at 200) |
| `failures` | failures/*.jsonl | Failure counts by category |
| `runs` | metrics/*.jsonl | Recent batch run summaries |
| `curated` | priority-queue.json | Curated overrides with validation status |
| `blockers` | priority-queue.json | Blocking dependencies |
| `disambiguations` | disambiguations.json | Disambiguation entries |

### CI Automation

The dashboard data is updated by the `update-dashboard.yml` workflow after each batch run. Preview deployments are created for PRs that change files under `website/`.

## Failure Subcategory Taxonomy

Failures are classified into categories (e.g., `deterministic`, `timeout`, `validation_failed`) and further refined with subcategories. Subcategory extraction uses a 3-level strategy:

1. **Bracketed tags** (highest confidence): Messages containing `[tag]` where `tag` is in the allowlist (e.g., `[no_bottles]`, `[verify_failed]`)
2. **Pattern matching**: Keywords in the error message (e.g., "no bottle" maps to `no_bottle`, "rate limit" maps to `rate_limited`)
3. **Exit code fallback** (lowest confidence): When no message is available, exit codes map to subcategories (e.g., exit code 6 = `install_failed`, exit code 7 = `verify_failed`)

**Known subcategories**:

| Subcategory | Meaning |
|-------------|---------|
| `no_bottles` | No pre-built bottle available for the target platform |
| `no_binaries` | No executables found after installation |
| `verify_failed` | Version verification pattern didn't match |
| `install_failed` | Installation step returned an error |
| `complex_archive` | Archive has unexpected structure |
| `timeout` | Operation exceeded time limit |
| `rate_limited` | Upstream API returned 429 or rate limit message |
| `api_error` | Upstream API returned an error |

## Health Status Panel

The health panel shows per-ecosystem pipeline state derived from the circuit breaker in `batch-control.json` and run history from metrics.

**Ecosystem States**:
- **healthy** (green): Circuit breaker closed, recent successful runs
- **degraded** (yellow): Circuit breaker half-open, or no recent success
- **open** (red): Circuit breaker open, pipeline paused for this ecosystem

**Indicators**:
- **Last Run**: When the most recent batch ran and its success rate
- **Last Successful Run**: When the pipeline last produced merged recipes
- **Runs Since Last Success**: Number of consecutive runs without a merge
- **Warning**: Displayed when no run has occurred in >2 hours

## Manual Regeneration

To regenerate dashboard data locally:

```bash
go run cmd/queue-analytics/main.go
```

After regeneration, verify the JSON:

```bash
# Check JSON syntax
jq '.' website/pipeline/dashboard.json > /dev/null && echo "Valid JSON"

# View health summary
jq '.health.ecosystems | to_entries[] | {key, state: .value.state}' website/pipeline/dashboard.json

# Count failures
jq '.failure_details | length' website/pipeline/dashboard.json
```

## Related Resources

- **Dashboard**: `/pipeline/` (view live dashboard)
- **Analyzer Tool**: [`cmd/queue-analytics/main.go`](https://github.com/tsukumogami/tsuku/blob/main/cmd/queue-analytics/main.go)
- **Data File**: [`website/pipeline/dashboard.json`](https://github.com/tsukumogami/tsuku/blob/main/website/pipeline/dashboard.json)
- **Design Document**: [`docs/designs/DESIGN-dashboard-observability.md`](https://github.com/tsukumogami/tsuku/blob/main/docs/designs/DESIGN-dashboard-observability.md)
- **Batch Operations Runbook**: [`docs/runbooks/batch-operations.md`](https://github.com/tsukumogami/tsuku/blob/main/docs/runbooks/batch-operations.md)
