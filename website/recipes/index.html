<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Browse available tsuku recipes - 150+ developer tools">
    <title>Recipes - tsuku</title>
    <link rel="stylesheet" href="/assets/style.css">
</head>
<body>
    <header>
        <nav>
            <a href="/" class="logo">tsuku</a>
            <a href="https://github.com/tsukumogami/tsuku" class="github-link" aria-label="GitHub">
                <svg viewBox="0 0 16 16" width="24" height="24" fill="currentColor">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                </svg>
            </a>
        </nav>
    </header>

    <main class="wide">
        <section class="hero">
            <h1>Recipes</h1>
            <p class="tagline">Browse available tools</p>
        </section>

        <section class="recipe-browser">
            <div class="search-container">
                <input
                    type="search"
                    id="recipe-search"
                    class="recipe-search"
                    placeholder="Search 150+ recipes..."
                    aria-label="Search recipes"
                >
            </div>

            <p id="recipe-count" class="recipe-count" hidden></p>

            <div id="recipe-grid" class="recipe-grid">
                <!-- Loading state (replaced by JS) -->
                <div class="loading-state" id="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Loading recipes...</p>
                </div>
            </div>

            <noscript>
                <div class="noscript-message">
                    <p>JavaScript is required to browse recipes.</p>
                    <p><a href="https://github.com/tsukumogami/tsuku/tree/main/internal/recipe/recipes">View recipes on GitHub</a></p>
                </div>
            </noscript>
        </section>

        <section class="links">
            <a href="/" class="link-btn">Back to Home</a>
            <a href="https://github.com/tsukumogami/tsuku/tree/main/internal/recipe/recipes" class="link-btn">View on GitHub</a>
        </section>
    </main>

    <footer>
        <p>
            <a href="/telemetry">Privacy</a>
            <span class="sep">|</span>
            <a href="https://github.com/tsukumogami/tsuku">GitHub</a>
        </p>
    </footer>

    <script>
        const API_URL = 'https://registry.tsuku.dev/recipes.json';
        const TIMEOUT_MS = 10000;

        let allRecipes = [];
        let isFetching = false;

        // ============================================================
        // Router
        // ============================================================

        // Determine view from URL path
        // Returns: { view: 'grid' } | { view: 'detail', recipe: string } | { view: '404' }
        function getViewFromURL() {
            const path = window.location.pathname;

            // Match /recipes/<name>/ or /recipes/<name>
            const detailMatch = path.match(/^\/recipes\/([a-z0-9-]+)\/?$/);
            if (detailMatch) {
                return { view: 'detail', recipe: detailMatch[1] };
            }

            // Match /recipes/ or /recipes
            if (path === '/recipes/' || path === '/recipes') {
                return { view: 'grid' };
            }

            // Unknown path under /recipes/*
            return { view: '404' };
        }

        // Navigate to a new path without page reload
        function navigateTo(path) {
            history.pushState(null, '', path);
            renderCurrentView();
        }

        // Debounce utility
        function debounce(fn, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        // Filter recipes by search query
        function filterRecipes(query) {
            const searchTerm = query.toLowerCase().trim();
            if (!searchTerm) {
                return allRecipes;
            }
            return allRecipes.filter(recipe =>
                recipe.name.toLowerCase().includes(searchTerm) ||
                recipe.description.toLowerCase().includes(searchTerm)
            );
        }

        // Handle search input
        function handleSearch() {
            const searchInput = document.getElementById('recipe-search');
            const query = searchInput.value;
            const filtered = filterRecipes(query);
            renderRecipes(filtered, query.trim().length > 0);
        }

        // Validate recipe has required fields and valid HTTPS URL
        function isValidRecipe(recipe) {
            if (!recipe || typeof recipe !== 'object') return false;
            if (typeof recipe.name !== 'string' || recipe.name.length === 0) return false;
            if (typeof recipe.description !== 'string') return false;
            if (typeof recipe.homepage !== 'string') return false;

            try {
                const url = new URL(recipe.homepage);
                return url.protocol === 'https:';
            } catch {
                return false;
            }
        }

        // Create a recipe card element using safe DOM APIs
        function createRecipeCard(recipe) {
            const card = document.createElement('article');
            card.className = 'recipe-card';

            const name = document.createElement('h3');
            name.className = 'recipe-name';
            name.textContent = recipe.name;

            const desc = document.createElement('p');
            desc.className = 'recipe-description';
            desc.textContent = recipe.description;

            const link = document.createElement('a');
            link.className = 'recipe-homepage';
            link.href = recipe.homepage;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.textContent = 'Homepage';

            card.appendChild(name);
            card.appendChild(desc);
            card.appendChild(link);

            return card;
        }

        // Render recipes to the grid
        function renderRecipes(recipes, isFiltered = false) {
            const grid = document.getElementById('recipe-grid');
            const countEl = document.getElementById('recipe-count');

            grid.innerHTML = '';

            if (recipes.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'no-results';
                const msg = document.createElement('p');
                msg.textContent = isFiltered ? 'No recipes match your search.' : 'No recipes available.';
                noResults.appendChild(msg);
                grid.appendChild(noResults);
                countEl.hidden = true;
                return;
            }

            recipes.forEach(recipe => {
                grid.appendChild(createRecipeCard(recipe));
            });

            if (isFiltered) {
                countEl.textContent = `Showing ${recipes.length} of ${allRecipes.length} recipes`;
            } else {
                countEl.textContent = `Showing ${recipes.length} recipes`;
            }
            countEl.hidden = false;
        }

        // Show error state with retry button
        function showError(message) {
            const grid = document.getElementById('recipe-grid');
            const countEl = document.getElementById('recipe-count');

            grid.innerHTML = '';
            countEl.hidden = true;

            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-state';

            const errorMsg = document.createElement('p');
            errorMsg.textContent = message;

            const retryBtn = document.createElement('button');
            retryBtn.className = 'link-btn';
            retryBtn.textContent = 'Try Again';
            retryBtn.addEventListener('click', loadRecipes);

            const fallbackP = document.createElement('p');
            fallbackP.className = 'error-fallback';
            const fallbackLink = document.createElement('a');
            fallbackLink.href = 'https://github.com/tsukumogami/tsuku/tree/main/internal/recipe/recipes';
            fallbackLink.textContent = 'View recipes on GitHub';
            fallbackP.appendChild(fallbackLink);

            errorDiv.appendChild(errorMsg);
            errorDiv.appendChild(retryBtn);
            errorDiv.appendChild(fallbackP);
            grid.appendChild(errorDiv);
        }

        // Fetch recipes from API
        async function loadRecipes() {
            // Guard against concurrent fetches
            if (isFetching) return;
            isFetching = true;

            const grid = document.getElementById('recipe-grid');
            const countEl = document.getElementById('recipe-count');

            // Show loading state
            grid.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Loading recipes...</p>
                </div>
            `;
            countEl.hidden = true;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);

                const response = await fetch(API_URL, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (!data.recipes || !Array.isArray(data.recipes)) {
                    throw new Error('Invalid response format');
                }

                // Validate and filter recipes
                allRecipes = data.recipes.filter(recipe => {
                    const valid = isValidRecipe(recipe);
                    if (!valid) {
                        console.warn('Skipping invalid recipe:', recipe);
                    }
                    return valid;
                });

                // Render the appropriate view based on URL
                renderCurrentView();
            } catch (error) {
                console.error('Failed to load recipes:', error);

                if (error.name === 'AbortError') {
                    showError('Request timed out. Please check your connection.');
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    showError('Unable to connect. Please check your connection.');
                } else {
                    showError('Failed to load recipes. Please try again.');
                }
            } finally {
                isFetching = false;
            }
        }

        // ============================================================
        // Detail View Helpers
        // ============================================================

        // Render install command with copy button
        function renderInstallCommand(container, recipeName) {
            const installSection = document.createElement('div');
            installSection.className = 'install-section';

            const label = document.createElement('p');
            label.className = 'install-label';
            label.textContent = 'Install with tsuku:';
            installSection.appendChild(label);

            const installBox = document.createElement('div');
            installBox.className = 'install-box';

            const code = document.createElement('code');
            code.textContent = `tsuku install ${recipeName}`;
            installBox.appendChild(code);

            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn';
            copyBtn.setAttribute('aria-label', 'Copy to clipboard');
            copyBtn.innerHTML = `<svg viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                <path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/>
                <path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/>
            </svg>`;
            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(code.textContent).then(() => {
                    copyBtn.classList.add('copied');
                    setTimeout(() => copyBtn.classList.remove('copied'), 2000);
                });
            });
            installBox.appendChild(copyBtn);

            installSection.appendChild(installBox);
            container.appendChild(installSection);
        }

        // Render dependencies grouped by type
        function renderDependencies(container, recipe) {
            const depsSection = document.createElement('div');
            depsSection.className = 'dependencies-section';

            const heading = document.createElement('h2');
            heading.textContent = 'Dependencies';
            depsSection.appendChild(heading);

            // Install dependencies
            if (recipe.dependencies && recipe.dependencies.length > 0) {
                const installDeps = document.createElement('div');
                installDeps.className = 'dep-group';

                const installLabel = document.createElement('h3');
                installLabel.textContent = 'Install Dependencies';
                installDeps.appendChild(installLabel);

                const installList = document.createElement('ul');
                installList.className = 'dep-list';
                recipe.dependencies.forEach(dep => {
                    const li = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = `/recipes/${dep}/`;
                    link.textContent = dep;
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        navigateTo(`/recipes/${dep}/`);
                    });
                    li.appendChild(link);
                    installList.appendChild(li);
                });
                installDeps.appendChild(installList);
                depsSection.appendChild(installDeps);
            }

            // Runtime dependencies
            if (recipe.runtime_dependencies && recipe.runtime_dependencies.length > 0) {
                const runtimeDeps = document.createElement('div');
                runtimeDeps.className = 'dep-group';

                const runtimeLabel = document.createElement('h3');
                runtimeLabel.textContent = 'Runtime Dependencies';
                runtimeDeps.appendChild(runtimeLabel);

                const runtimeList = document.createElement('ul');
                runtimeList.className = 'dep-list';
                recipe.runtime_dependencies.forEach(dep => {
                    const li = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = `/recipes/${dep}/`;
                    link.textContent = dep;
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        navigateTo(`/recipes/${dep}/`);
                    });
                    li.appendChild(link);
                    runtimeList.appendChild(li);
                });
                runtimeDeps.appendChild(runtimeList);
                depsSection.appendChild(runtimeDeps);
            }

            container.appendChild(depsSection);
        }

        // ============================================================
        // View Renderers
        // ============================================================

        // Render the grid view (recipe browser)
        function renderGridView() {
            // Show search container and tagline
            const searchContainer = document.querySelector('.search-container');
            if (searchContainer) searchContainer.hidden = false;
            const tagline = document.querySelector('.hero .tagline');
            if (tagline) tagline.hidden = false;

            // Apply current search filter
            const searchInput = document.getElementById('recipe-search');
            const query = searchInput ? searchInput.value : '';
            const filtered = filterRecipes(query);
            renderRecipes(filtered, query.trim().length > 0);
        }

        // Render detail view for a recipe
        function renderDetailView(recipeName) {
            const recipe = allRecipes.find(r => r.name === recipeName);
            if (!recipe) {
                render404();
                return;
            }

            // Hide search container and tagline in detail view
            const searchContainer = document.querySelector('.search-container');
            if (searchContainer) searchContainer.hidden = true;
            const tagline = document.querySelector('.hero .tagline');
            if (tagline) tagline.hidden = true;

            const grid = document.getElementById('recipe-grid');
            const countEl = document.getElementById('recipe-count');
            grid.innerHTML = '';
            countEl.hidden = true;

            const detail = document.createElement('section');
            detail.className = 'recipe-detail';

            // Recipe name
            const h1 = document.createElement('h1');
            h1.textContent = recipe.name;
            detail.appendChild(h1);

            // Description
            const desc = document.createElement('p');
            desc.className = 'description';
            desc.textContent = recipe.description;
            detail.appendChild(desc);

            // Homepage link
            const homepageP = document.createElement('p');
            homepageP.className = 'homepage';
            const homepageLink = document.createElement('a');
            homepageLink.href = recipe.homepage;
            homepageLink.textContent = 'Official Homepage';
            homepageLink.target = '_blank';
            homepageLink.rel = 'noopener noreferrer';
            homepageP.appendChild(homepageLink);
            detail.appendChild(homepageP);

            // Install command with copy button
            renderInstallCommand(detail, recipe.name);

            // Dependencies (if any)
            if ((recipe.dependencies && recipe.dependencies.length > 0) ||
                (recipe.runtime_dependencies && recipe.runtime_dependencies.length > 0)) {
                renderDependencies(detail, recipe);
            }

            // Back link
            const back = document.createElement('a');
            back.href = '/recipes/';
            back.className = 'link-btn';
            back.textContent = 'Back to Recipes';
            back.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/recipes/');
            });
            detail.appendChild(back);

            grid.appendChild(detail);
        }

        // Render 404 view for unknown recipes
        function render404() {
            // Hide search container
            const searchContainer = document.querySelector('.search-container');
            if (searchContainer) searchContainer.hidden = true;

            const grid = document.getElementById('recipe-grid');
            const countEl = document.getElementById('recipe-count');
            grid.innerHTML = '';
            countEl.hidden = true;

            const notFound = document.createElement('div');
            notFound.className = 'error-state';

            const msg = document.createElement('p');
            msg.textContent = 'Recipe not found.';
            notFound.appendChild(msg);

            const back = document.createElement('a');
            back.href = '/recipes/';
            back.className = 'link-btn';
            back.textContent = 'Back to Recipes';
            back.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/recipes/');
            });
            notFound.appendChild(back);

            grid.appendChild(notFound);
        }

        // Dispatch to the appropriate view based on current URL
        function renderCurrentView() {
            const viewState = getViewFromURL();

            switch (viewState.view) {
                case 'grid':
                    renderGridView();
                    break;
                case 'detail':
                    renderDetailView(viewState.recipe);
                    break;
                case '404':
                default:
                    render404();
                    break;
            }
        }

        // ============================================================
        // Initialization
        // ============================================================

        // Check for redirect from 404.html (workaround for Cloudflare Pages splat bug)
        // See: https://github.com/cloudflare/workers-sdk/issues/2671
        function handleRedirectParam() {
            const params = new URLSearchParams(window.location.search);
            const redirectPath = params.get('p');
            if (redirectPath && redirectPath.startsWith('/recipes/')) {
                // Restore the clean URL without the ?p= param
                history.replaceState(null, '', redirectPath);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Handle redirect from 404.html first
            handleRedirectParam();

            // Set up search with debouncing
            const searchInput = document.getElementById('recipe-search');
            const debouncedSearch = debounce(handleSearch, 150);
            searchInput.addEventListener('input', debouncedSearch);

            // Handle browser back/forward
            window.addEventListener('popstate', renderCurrentView);

            // Load recipes, then render current view
            loadRecipes();
        });
    </script>
</body>
</html>
