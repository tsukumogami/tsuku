name: Validate Golden Files (Recipes)

on:
  pull_request:
    branches: [main]
    paths:
      - 'internal/recipe/recipes/**/*.toml'
      - 'recipes/**/*.toml'
      - 'testdata/golden/exclusions.json'
      - '.github/workflows/validate-golden-recipes.yml'
  workflow_dispatch:

jobs:
  validate-exclusions:
    name: Validate Exclusions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for stale exclusions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./scripts/validate-golden-exclusions.sh --check-issues

  detect-changes:
    name: Detect Changes
    needs: validate-exclusions
    runs-on: ubuntu-latest
    outputs:
      recipes: ${{ steps.changed.outputs.recipes }}
      has_changes: ${{ steps.changed.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed recipes
        id: changed
        run: |
          # Get list of changed recipe files (exclude deleted files)
          # Check both embedded (internal/recipe/recipes) and registry (recipes/) locations
          CHANGED=$(git diff --name-only --diff-filter=d origin/main...HEAD -- 'internal/recipe/recipes/**/*.toml' 'recipes/**/*.toml')

          if [ -z "$CHANGED" ]; then
            echo "No recipe files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "recipes=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed recipes:"
          echo "$CHANGED"

          # Build JSON array of {recipe, category} objects
          # All recipes must have golden files - fail if any are missing
          JSON="["
          FIRST=true
          for path in $CHANGED; do
            # Skip if file doesn't exist (deleted in later commit)
            if [ ! -f "$path" ]; then
              echo "Skipping deleted recipe: $path"
              continue
            fi

            recipe=$(basename "$path" .toml)

            # Detect category from path and determine golden directory
            if [[ "$path" == internal/recipe/recipes/* ]]; then
              category="embedded"
              golden_dir="testdata/golden/plans/embedded/$recipe"
            else
              category="registry"
              first_letter="${recipe:0:1}"
              golden_dir="testdata/golden/plans/$first_letter/$recipe"
            fi

            # Check if recipe has golden files
            if [ ! -d "$golden_dir" ]; then
              # Check if recipe is fully excluded (has exclusions for all platforms)
              exclusion_count=$(jq --arg r "$recipe" '[.exclusions[] | select(.recipe == $r)] | length' testdata/golden/exclusions.json)
              if [ "$exclusion_count" -gt 0 ]; then
                echo "Recipe '$recipe' has no golden files but is excluded ($exclusion_count exclusion(s))"
                continue
              fi
              echo "::error::Recipe '$recipe' has no golden files. Run './scripts/regenerate-golden.sh $recipe --category $category' to generate them."
              echo "::error::Or add exclusions to testdata/golden/exclusions.json with a tracking issue."
              exit 1
            fi

            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              JSON="$JSON,"
            fi
            JSON="$JSON{\"recipe\":\"$recipe\",\"category\":\"$category\"}"
          done
          JSON="$JSON]"

          if [ "$JSON" = "[]" ]; then
            echo "No recipes with golden files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
          echo "recipes=$JSON" >> $GITHUB_OUTPUT

  validate-golden:
    name: "Validate: ${{ matrix.item.recipe }}"
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        item: ${{ fromJson(needs.detect-changes.outputs.recipes) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache-dependency-path: go.sum

      - name: Cache downloads
        uses: actions/cache@v4
        with:
          path: ~/.tsuku/cache/downloads
          key: golden-downloads-${{ matrix.item.recipe }}-${{ matrix.item.category }}
          restore-keys: |
            golden-downloads-${{ matrix.item.recipe }}-
            golden-downloads-

      - name: Build tsuku
        run: CGO_ENABLED=0 go build -o tsuku ./cmd/tsuku

      - name: Validate golden files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Validating golden files for ${{ matrix.item.recipe }} (${{ matrix.item.category }})..."
          if ! ./scripts/validate-golden.sh "${{ matrix.item.recipe }}" --category "${{ matrix.item.category }}"; then
            echo ""
            echo "::error::Golden files are out of date for recipe '${{ matrix.item.recipe }}'."
            echo "::error::Run './scripts/regenerate-golden.sh ${{ matrix.item.recipe }} --category ${{ matrix.item.category }}' and commit the changes."
            exit 1
          fi
