name: Validate Golden Files (Recipes)

on:
  pull_request:
    branches: [main]
    paths:
      - 'internal/recipe/recipes/**/*.toml'
      - 'recipes/**/*.toml'
      - 'testdata/golden/exclusions.json'
      - '.github/workflows/validate-golden-recipes.yml'
  workflow_dispatch:

jobs:
  validate-exclusions:
    name: Validate Exclusions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Check for stale exclusions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./scripts/validate-golden-exclusions.sh --check-issues

  # Check R2 availability for registry recipe validation
  r2-health-check:
    name: R2 Health Check
    runs-on: ubuntu-latest
    outputs:
      r2_available: ${{ steps.check.outputs.r2_available }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Check R2 health
        id: check
        env:
          R2_BUCKET_URL: ${{ secrets.R2_BUCKET_URL }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID_READONLY }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY_READONLY }}
        run: |
          # Check if R2 credentials are configured
          if [[ -z "$R2_BUCKET_URL" ]] || [[ -z "$R2_ACCESS_KEY_ID" ]] || [[ -z "$R2_SECRET_ACCESS_KEY" ]]; then
            echo "::warning::R2 credentials not configured, registry validation will use git fallback"
            echo "r2_available=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Checking R2 health..."
          if ./scripts/r2-health-check.sh; then
            echo "r2_available=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::R2 health check failed, registry validation will use git fallback"
            echo "r2_available=false" >> $GITHUB_OUTPUT
          fi

  detect-changes:
    name: Detect Changes
    needs: validate-exclusions
    runs-on: ubuntu-latest
    outputs:
      recipes: ${{ steps.changed.outputs.recipes }}
      has_changes: ${{ steps.changed.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 0

      - name: Get changed recipes
        id: changed
        run: |
          # Get list of changed recipe files (exclude deleted files)
          # Check both embedded (internal/recipe/recipes) and registry (recipes/) locations
          CHANGED=$(git diff --name-only --diff-filter=d origin/main...HEAD -- 'internal/recipe/recipes/**/*.toml' 'recipes/**/*.toml')

          if [ -z "$CHANGED" ]; then
            echo "No recipe files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "recipes=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed recipes:"
          echo "$CHANGED"

          # Build JSON array of {recipe, category} objects
          # All recipes must have golden files - fail if any are missing
          JSON="["
          FIRST=true
          for path in $CHANGED; do
            # Skip if file doesn't exist (deleted in later commit)
            if [ ! -f "$path" ]; then
              echo "Skipping deleted recipe: $path"
              continue
            fi

            recipe=$(basename "$path" .toml)

            # Detect category from path and determine golden directory
            if [[ "$path" == internal/recipe/recipes/* ]]; then
              category="embedded"
              golden_dir="testdata/golden/plans/embedded/$recipe"
            else
              category="registry"
              first_letter="${recipe:0:1}"
              golden_dir="testdata/golden/plans/$first_letter/$recipe"
            fi

            # Check if recipe has golden files (for embedded recipes only - registry uses R2)
            # For registry recipes, we'll validate using TSUKU_GOLDEN_SOURCE=r2
            if [[ "$category" == "embedded" ]] && [ ! -d "$golden_dir" ]; then
              # Check if recipe is fully excluded (has exclusions for all platforms)
              exclusion_count=$(jq --arg r "$recipe" '[.exclusions[] | select(.recipe == $r)] | length' testdata/golden/exclusions.json)
              if [ "$exclusion_count" -gt 0 ]; then
                echo "Recipe '$recipe' has no golden files but is excluded ($exclusion_count exclusion(s))"
                continue
              fi
              echo "::error::Recipe '$recipe' has no golden files. Run './scripts/regenerate-golden.sh $recipe --category $category' to generate them."
              echo "::error::Or add exclusions to testdata/golden/exclusions.json with a tracking issue."
              exit 1
            fi

            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              JSON="$JSON,"
            fi
            JSON="$JSON{\"recipe\":\"$recipe\",\"category\":\"$category\"}"
          done
          JSON="$JSON]"

          if [ "$JSON" = "[]" ]; then
            echo "No recipes with golden files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
          echo "recipes=$JSON" >> $GITHUB_OUTPUT

  validate-golden:
    name: "Validate: ${{ matrix.item.recipe }}"
    needs: [detect-changes, r2-health-check]
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        item: ${{ fromJson(needs.detect-changes.outputs.recipes) }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff  # v5
        with:
          go-version-file: 'go.mod'
          cache-dependency-path: go.sum

      - name: Cache downloads
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4
        with:
          path: ~/.tsuku/cache/downloads
          key: golden-downloads-${{ matrix.item.recipe }}-${{ matrix.item.category }}
          restore-keys: |
            golden-downloads-${{ matrix.item.recipe }}-
            golden-downloads-

      - name: Build tsuku
        run: CGO_ENABLED=0 go build -o tsuku ./cmd/tsuku

      - name: Validate golden files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          R2_BUCKET_URL: ${{ secrets.R2_BUCKET_URL }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID_READONLY }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY_READONLY }}
          R2_AVAILABLE: ${{ needs.r2-health-check.outputs.r2_available }}
        run: |
          RECIPE="${{ matrix.item.recipe }}"
          CATEGORY="${{ matrix.item.category }}"

          echo "Validating golden files for $RECIPE ($CATEGORY)..."

          # Determine golden source based on category and R2 availability
          if [[ "$CATEGORY" == "embedded" ]]; then
            # Embedded recipes always use git
            export TSUKU_GOLDEN_SOURCE=git
          elif [[ "$R2_AVAILABLE" == "true" ]]; then
            # Registry recipes use R2 when available
            export TSUKU_GOLDEN_SOURCE=r2

            # Check if golden files exist in R2 for this recipe
            # New recipes won't have golden files yet - skip validation with notice
            if ! ./scripts/check-golden-exists.sh "$RECIPE" --category "$CATEGORY"; then
              echo "::notice::Skipping validation for new recipe '$RECIPE' - golden files will be generated after merge"
              exit 0
            fi
          else
            # R2 unavailable - skip registry recipe validation with warning
            echo "::warning::Skipping $RECIPE validation - R2 unavailable (registry recipes require R2 golden files)"
            echo "Registry recipe validation will be performed by nightly workflow when R2 is available"
            exit 0
          fi

          echo "Using TSUKU_GOLDEN_SOURCE=$TSUKU_GOLDEN_SOURCE"

          if ! ./scripts/validate-golden.sh "$RECIPE" --category "$CATEGORY"; then
            echo ""
            echo "::error::Golden files are out of date for recipe '$RECIPE'."
            if [[ "$CATEGORY" == "embedded" ]]; then
              echo "::error::Run './scripts/regenerate-golden.sh $RECIPE --category $CATEGORY' and commit the changes."
            else
              echo "::error::Golden files in R2 don't match. The post-merge workflow will regenerate them after merge."
              echo "::error::If this is unexpected, check that the recipe changes are correct."
            fi
            exit 1
          fi
