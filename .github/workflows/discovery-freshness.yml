# Weekly freshness check for discovery registry entries.
#
# Validates that all entries in recipes/discovery/ still resolve to valid
# sources (repos not archived/deleted, formulas not deprecated, etc.).
#
# On failure, creates a GitHub issue listing stale entries.
name: Discovery Registry Freshness

on:
  schedule:
    - cron: '0 6 * * 1'  # Weekly Monday 6 AM UTC
  workflow_dispatch: {}

jobs:
  validate:
    name: Validate Discovery Entries
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: 'go.mod'
          cache-dependency-path: go.sum

      - name: Build seed-discovery
        run: go build -o seed-discovery ./cmd/seed-discovery

      - name: Validate discovery entries
        id: validate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./seed-discovery --validate-only recipes/discovery --verbose 2>&1 | tee validation.log
        continue-on-error: true

      - name: Check validation result
        id: check
        run: |
          if grep -q "0 failed" validation.log; then
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Create failure issue
        if: steps.check.outputs.passed == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract failure lines from log
          FAILURES=$(grep -A1 "Failures:" validation.log | tail -n +2 || true)
          if [ -z "$FAILURES" ]; then
            FAILURES="See workflow run for details."
          fi

          BODY="$(cat <<EOF
          ## Discovery Registry Freshness Check Failed

          The weekly freshness check found stale entries in the discovery registry.

          **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ### Stale Entries

          \`\`\`
          $FAILURES
          \`\`\`

          ### Next Steps

          1. Check the workflow run for detailed logs
          2. Remove or update stale entries
          3. Re-run the workflow to verify fixes
          EOF
          )"

          # Check for existing open issue
          EXISTING=$(gh issue list --label "maintenance,discovery-registry" --state open --json number --limit 1 | jq -r '.[0].number // empty')

          if [ -n "$EXISTING" ]; then
            echo "Adding comment to existing issue #$EXISTING"
            gh issue comment "$EXISTING" --body "$BODY"
          else
            echo "Creating new issue"
            gh issue create \
              --title "[Automated] Discovery Registry Freshness Check Failed - $(date +%Y-%m-%d)" \
              --body "$BODY" \
              --label "maintenance,discovery-registry"
          fi

          exit 1
