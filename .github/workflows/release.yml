name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  create-draft-release:
    name: Create Draft Release
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create.outputs.release_id }}
      upload_url: ${{ steps.create.outputs.upload_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for tag annotations

      - name: Create draft release
        id: create
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"

          # Extract release notes from annotated tag message
          TAG_MESSAGE=$(git for-each-ref --format='%(contents)' "refs/tags/${TAG}")

          if [ -z "$TAG_MESSAGE" ]; then
            echo "::warning::No tag annotation found, using auto-generated notes"
            NOTES_FLAG="--generate-notes"
          else
            # Write to temp file to preserve formatting
            echo "$TAG_MESSAGE" > /tmp/release-notes.md
            NOTES_FLAG="--notes-file /tmp/release-notes.md"
          fi

          # Create draft release and capture the response
          RESPONSE=$(gh release create "$TAG" \
            --draft \
            $NOTES_FLAG \
            --title "$TAG" \
            --json id,uploadUrl)

          # Extract outputs
          RELEASE_ID=$(echo "$RESPONSE" | jq -r '.id')
          UPLOAD_URL=$(echo "$RESPONSE" | jq -r '.uploadUrl')

          echo "release_id=$RELEASE_ID" >> "$GITHUB_OUTPUT"
          echo "upload_url=$UPLOAD_URL" >> "$GITHUB_OUTPUT"
          echo "Created draft release $TAG (ID: $RELEASE_ID)"

  release:
    name: Release
    needs: [create-draft-release]
    if: needs.create-draft-release.result == 'success'
    runs-on: ubuntu-latest
    env:
      RELEASE_ID: ${{ needs.create-draft-release.outputs.release_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          cache-dependency-path: go.sum

      - name: Verify go.mod is tidy
        run: |
          go mod tidy
          if ! git diff --exit-code go.mod go.sum; then
            echo "::error::go.mod or go.sum is not tidy. Cannot release with untidy module files."
            exit 1
          fi

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  finalize-release:
    name: Finalize Release
    needs: [create-draft-release, release]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Publish release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          gh release edit "$TAG" --draft=false
          echo "Published release $TAG"
