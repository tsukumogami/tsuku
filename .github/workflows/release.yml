name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  # GoReleaser creates the draft release and builds Go binaries
  release:
    name: Release (Go)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          cache-dependency-path: go.sum

      - name: Verify go.mod is tidy
        run: |
          go mod tidy
          if ! git diff --exit-code go.mod go.sum; then
            echo "::error::go.mod or go.sum is not tidy. Cannot release with untidy module files."
            exit 1
          fi

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build Rust binary (tsuku-dltest) on native runners
  build-rust:
    name: "Build Rust (${{ matrix.platform }})"
    needs: [release]
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux glibc builds
          - platform: linux-amd64
            runner: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            artifact: tsuku-dltest-linux-amd64
          - platform: linux-arm64
            runner: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            artifact: tsuku-dltest-linux-arm64
          # macOS builds
          - platform: darwin-amd64
            runner: macos-13
            target: x86_64-apple-darwin
            artifact: tsuku-dltest-darwin-amd64
          - platform: darwin-arm64
            runner: macos-latest
            target: aarch64-apple-darwin
            artifact: tsuku-dltest-darwin-arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            cmd/tsuku-dltest

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.75"

      - name: Inject version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/^version = .*/version = \"$VERSION\"/" cmd/tsuku-dltest/Cargo.toml
          else
            sed -i "s/^version = .*/version = \"$VERSION\"/" cmd/tsuku-dltest/Cargo.toml
          fi
          echo "Building version: $VERSION"

      - name: Build release binary
        working-directory: cmd/tsuku-dltest
        run: cargo build --release

      - name: Sign binary (macOS)
        if: startsWith(matrix.runner, 'macos')
        run: codesign -s - cmd/tsuku-dltest/target/release/tsuku-dltest

      - name: Upload to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cp cmd/tsuku-dltest/target/release/tsuku-dltest "${{ matrix.artifact }}"
          gh release upload "${GITHUB_REF_NAME}" "${{ matrix.artifact }}" --clobber

  # Build Rust binary with musl (Alpine container)
  build-rust-musl:
    name: "Build Rust (${{ matrix.platform }}-musl)"
    needs: [release]
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux-amd64
            runner: ubuntu-22.04
            artifact: tsuku-dltest-linux-amd64-musl
          - platform: linux-arm64
            runner: ubuntu-24.04-arm
            artifact: tsuku-dltest-linux-arm64-musl
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            cmd/tsuku-dltest

      - name: Inject version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          sed -i "s/^version = .*/version = \"$VERSION\"/" cmd/tsuku-dltest/Cargo.toml
          echo "Building version: $VERSION"

      - name: Build in Alpine container
        run: |
          docker run --rm -v "$PWD:/workspace" -w /workspace alpine:3.19 sh -c '
            apk add --no-cache rust cargo
            cd cmd/tsuku-dltest
            cargo build --release
          '

      - name: Upload to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cp cmd/tsuku-dltest/target/release/tsuku-dltest "${{ matrix.artifact }}"
          gh release upload "${GITHUB_REF_NAME}" "${{ matrix.artifact }}" --clobber

  # Integration tests on native platforms
  integration-test:
    name: "Integration Test (${{ matrix.platform }})"
    needs: [release, build-rust, build-rust-musl]
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux-amd64
            runner: ubuntu-22.04
            tsuku_binary: tsuku-linux-amd64
            dltest_binary: tsuku-dltest-linux-amd64
          - platform: linux-arm64
            runner: ubuntu-24.04-arm
            tsuku_binary: tsuku-linux-arm64
            dltest_binary: tsuku-dltest-linux-arm64
          - platform: darwin-amd64
            runner: macos-13
            tsuku_binary: tsuku-darwin-amd64
            dltest_binary: tsuku-dltest-darwin-amd64
          - platform: darwin-arm64
            runner: macos-latest
            tsuku_binary: tsuku-darwin-arm64
            dltest_binary: tsuku-dltest-darwin-arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Download binaries from draft release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          mkdir -p ./artifacts
          gh release download "$TAG" \
            --repo "$GITHUB_REPOSITORY" \
            --pattern "${{ matrix.tsuku_binary }}" \
            --pattern "${{ matrix.dltest_binary }}" \
            --dir ./artifacts
          chmod +x ./artifacts/*

      - name: Validate tsuku version
        run: |
          TAG="${GITHUB_REF_NAME}"
          EXPECTED_VERSION="${TAG#v}"
          TSUKU_VERSION=$(./artifacts/${{ matrix.tsuku_binary }} --version 2>&1)
          echo "tsuku version output: $TSUKU_VERSION"
          if ! echo "$TSUKU_VERSION" | grep -q "$EXPECTED_VERSION"; then
            echo "ERROR: tsuku version mismatch"
            echo "Expected to contain: $EXPECTED_VERSION"
            echo "Got: $TSUKU_VERSION"
            exit 1
          fi
          echo "tsuku version check passed"

      - name: Validate tsuku-dltest version
        run: |
          TAG="${GITHUB_REF_NAME}"
          EXPECTED_VERSION="${TAG#v}"
          DLTEST_VERSION=$(./artifacts/${{ matrix.dltest_binary }} --version 2>&1)
          echo "tsuku-dltest version output: $DLTEST_VERSION"
          if ! echo "$DLTEST_VERSION" | grep -q "$EXPECTED_VERSION"; then
            echo "ERROR: tsuku-dltest version mismatch"
            echo "Expected to contain: $EXPECTED_VERSION"
            echo "Got: $DLTEST_VERSION"
            exit 1
          fi
          echo "tsuku-dltest version check passed"

  finalize-release:
    name: Finalize Release
    needs: [integration-test]
    runs-on: ubuntu-latest
    steps:
      - name: Verify all artifacts present
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          EXPECTED_ARTIFACTS=(
            # Go binaries (from goreleaser)
            tsuku-linux-amd64
            tsuku-linux-arm64
            tsuku-darwin-amd64
            tsuku-darwin-arm64
            # Rust binaries - glibc (from build-rust)
            tsuku-dltest-linux-amd64
            tsuku-dltest-linux-arm64
            tsuku-dltest-darwin-amd64
            tsuku-dltest-darwin-arm64
            # Rust binaries - musl (from build-rust-musl)
            tsuku-dltest-linux-amd64-musl
            tsuku-dltest-linux-arm64-musl
          )

          echo "Verifying all ${#EXPECTED_ARTIFACTS[@]} artifacts are present..."
          ASSETS=$(gh release view "$TAG" --json assets -q '.assets[].name')

          for artifact in "${EXPECTED_ARTIFACTS[@]}"; do
            if ! echo "$ASSETS" | grep -q "^${artifact}$"; then
              echo "ERROR: Missing artifact: $artifact"
              exit 1
            fi
            echo "Found: $artifact"
          done
          echo "All artifacts verified"

      - name: Download artifacts and generate checksums
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          mkdir -p ./artifacts
          cd ./artifacts

          # Download all binary artifacts (exclude existing checksums.txt from goreleaser)
          gh release download "$TAG" \
            --repo "$GITHUB_REPOSITORY" \
            --pattern "tsuku-*" \
            --skip-existing

          # Generate unified checksums for all binaries
          sha256sum tsuku-* > checksums.txt
          echo "Generated checksums.txt:"
          cat checksums.txt

      - name: Upload checksums
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          gh release upload "$TAG" ./artifacts/checksums.txt --clobber
          echo "Uploaded checksums.txt"

      - name: Publish release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          gh release edit "$TAG" --draft=false
          echo "Published release $TAG"
