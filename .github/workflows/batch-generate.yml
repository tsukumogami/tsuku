name: Batch Recipe Generation
on:
  workflow_dispatch:
    inputs:
      ecosystem:
        description: 'Ecosystem to process'
        required: true
        default: 'homebrew'
        type: choice
        options:
          - homebrew
          - cargo
          - npm
          - pypi
          - rubygems
          - go
          - cpan
          - cask
      batch_size:
        description: 'Max recipes per run'
        required: true
        default: '25'
      tier:
        description: 'Queue tier (1=critical, 2=popular, 3=all)'
        required: true
        default: '2'
        type: choice
        options: ['1', '2', '3']

concurrency:
  group: batch-generate
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    runs-on: ubuntu-latest
    outputs:
      has_recipes: ${{ steps.check.outputs.changes }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build binaries
        run: |
          go build -o batch-generate ./cmd/batch-generate
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o tsuku-linux-amd64 ./cmd/tsuku
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -o tsuku-linux-arm64 ./cmd/tsuku
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -o tsuku-darwin-arm64 ./cmd/tsuku
          CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -o tsuku-darwin-amd64 ./cmd/tsuku
          cp tsuku-linux-amd64 tsuku
          echo "$PWD" >> "$GITHUB_PATH"

      - name: Run batch generation
        run: |
          ./batch-generate \
            -ecosystem "${{ inputs.ecosystem }}" \
            -batch-size "${{ inputs.batch_size }}" \
            -tier "${{ inputs.tier }}"

      - name: Requeue unblocked packages
        run: ./scripts/requeue-unblocked.sh

      - name: Check for generated recipes
        id: check
        run: |
          if git diff --quiet && [ -z "$(git ls-files --others --exclude-standard recipes/)" ]; then
            echo "changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload passing recipes
        if: steps.check.outputs.changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: passing-recipes
          path: |
            recipes/
            data/
          retention-days: 1

      - name: Upload tsuku binaries
        if: steps.check.outputs.changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: tsuku-binaries
          path: |
            tsuku-linux-amd64
            tsuku-linux-arm64
            tsuku-darwin-arm64
            tsuku-darwin-amd64
          retention-days: 1

  validate-linux-x86_64:
    needs: generate
    if: needs.generate.outputs.has_recipes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: passing-recipes
          path: artifacts

      - uses: actions/download-artifact@v4
        with:
          name: tsuku-binaries

      - name: Make binary executable
        run: chmod +x tsuku-linux-amd64

      - name: Collect new recipe list
        id: recipes
        run: |
          # Find recipes that were generated (in artifacts but not in checkout)
          RECIPE_LIST=""
          for f in artifacts/recipes/*/*.toml; do
            basename_path="${f#artifacts/}"
            if [ ! -f "$basename_path" ]; then
              RECIPE_LIST="$RECIPE_LIST $basename_path"
            fi
          done
          echo "list=$RECIPE_LIST" >> "$GITHUB_OUTPUT"

      - name: Copy new recipes into working tree
        run: cp -r artifacts/recipes/* recipes/

      - name: Validate on all Linux x86_64 families
        run: |
          RESULTS="[]"
          IMAGES=("debian:bookworm-slim" "fedora:41" "archlinux:base" "opensuse/tumbleweed" "alpine:3.21")
          NAMES=("debian" "rhel" "arch" "suse" "alpine")
          LIBCS=("glibc" "glibc" "glibc" "glibc" "musl")

          for i in "${!IMAGES[@]}"; do
            image="${IMAGES[$i]}"
            family="${NAMES[$i]}"
            libc="${LIBCS[$i]}"
            platform="linux-${family}-${libc}-x86_64"

            echo "=== Validating on $platform ($image) ==="

            for recipe_path in ${{ steps.recipes.outputs.list }}; do
              recipe_name=$(basename "$recipe_path" .toml)

              case "$recipe_path" in
                *..*) echo "SKIP: path traversal in $recipe_path"; continue ;;
              esac

              echo "--- $recipe_name on $platform ---"
              STATUS="pass"
              EXIT_CODE=0
              ATTEMPTS=1

              for attempt in 1 2 3; do
                ATTEMPTS=$attempt
                # Write tsuku exit code to file so Docker doesn't mask it
                docker run --rm \
                  -v "$PWD:/workspace" \
                  -w /workspace \
                  "$image" \
                  sh -c "
                    case '$family' in
                      alpine) apk add --no-cache curl bash ca-certificates ;;
                      debian) apt-get update && apt-get install -y --no-install-recommends curl ca-certificates ;;
                      rhel) dnf install -y --setopt=install_weak_deps=False curl ca-certificates ;;
                      arch) pacman -Sy --noconfirm curl ca-certificates ;;
                      suse) zypper -n install curl ca-certificates ;;
                    esac
                    timeout 300 ./tsuku-linux-amd64 install --force --recipe '$recipe_path'
                    echo \$? > /workspace/.tsuku-exit-code
                  " 2>&1 || true

                if [ -f .tsuku-exit-code ]; then
                  EXIT_CODE=$(cat .tsuku-exit-code)
                  rm -f .tsuku-exit-code
                else
                  # Container failed before running tsuku (Docker error)
                  EXIT_CODE=1
                fi

                if [ "$EXIT_CODE" = "0" ]; then
                  STATUS="pass"
                  break
                elif [ "$EXIT_CODE" = "5" ] && [ "$attempt" -lt 3 ]; then
                  echo "Network error, retrying (attempt $((attempt+1)))..."
                  sleep $((2 ** attempt))
                  continue
                else
                  STATUS="fail"
                  break
                fi
              done

              RESULTS=$(echo "$RESULTS" | jq --arg r "$recipe_name" --arg p "$platform" \
                --arg s "$STATUS" --argjson e "$EXIT_CODE" --argjson a "$ATTEMPTS" \
                '. + [{"recipe": $r, "platform": $p, "status": $s, "exit_code": $e, "attempts": $a}]')
            done
          done

          echo "$RESULTS" > validation-results-linux-x86_64.json
          echo "### Linux x86_64 Validation Results" >> "$GITHUB_STEP_SUMMARY"
          echo '```json' >> "$GITHUB_STEP_SUMMARY"
          echo "$RESULTS" | jq . >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - uses: actions/upload-artifact@v4
        with:
          name: validation-results-linux-x86_64
          path: validation-results-linux-x86_64.json
          retention-days: 1

  validate-linux-arm64:
    needs: generate
    if: needs.generate.outputs.has_recipes == 'true'
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: passing-recipes
          path: artifacts

      - uses: actions/download-artifact@v4
        with:
          name: tsuku-binaries

      - name: Make binary executable
        run: chmod +x tsuku-linux-arm64

      - name: Collect new recipe list
        id: recipes
        run: |
          RECIPE_LIST=""
          for f in artifacts/recipes/*/*.toml; do
            basename_path="${f#artifacts/}"
            if [ ! -f "$basename_path" ]; then
              RECIPE_LIST="$RECIPE_LIST $basename_path"
            fi
          done
          echo "list=$RECIPE_LIST" >> "$GITHUB_OUTPUT"

      - name: Copy new recipes into working tree
        run: cp -r artifacts/recipes/* recipes/

      - name: Validate on all Linux arm64 families
        run: |
          RESULTS="[]"
          IMAGES=("debian:bookworm-slim" "fedora:41" "archlinux:base" "opensuse/tumbleweed" "alpine:3.21")
          NAMES=("debian" "rhel" "arch" "suse" "alpine")
          LIBCS=("glibc" "glibc" "glibc" "glibc" "musl")

          for i in "${!IMAGES[@]}"; do
            image="${IMAGES[$i]}"
            family="${NAMES[$i]}"
            libc="${LIBCS[$i]}"
            platform="linux-${family}-${libc}-arm64"

            echo "=== Validating on $platform ($image) ==="

            for recipe_path in ${{ steps.recipes.outputs.list }}; do
              recipe_name=$(basename "$recipe_path" .toml)

              case "$recipe_path" in
                *..*) echo "SKIP: path traversal in $recipe_path"; continue ;;
              esac

              echo "--- $recipe_name on $platform ---"
              STATUS="pass"
              EXIT_CODE=0
              ATTEMPTS=1

              for attempt in 1 2 3; do
                ATTEMPTS=$attempt
                docker run --rm \
                  -v "$PWD:/workspace" \
                  -w /workspace \
                  "$image" \
                  sh -c "
                    case '$family' in
                      alpine) apk add --no-cache curl bash ca-certificates ;;
                      debian) apt-get update && apt-get install -y --no-install-recommends curl ca-certificates ;;
                      rhel) dnf install -y --setopt=install_weak_deps=False curl ca-certificates ;;
                      arch) pacman -Sy --noconfirm curl ca-certificates ;;
                      suse) zypper -n install curl ca-certificates ;;
                    esac
                    timeout 300 ./tsuku-linux-arm64 install --force --recipe '$recipe_path'
                    echo \$? > /workspace/.tsuku-exit-code
                  " 2>&1 || true

                if [ -f .tsuku-exit-code ]; then
                  EXIT_CODE=$(cat .tsuku-exit-code)
                  rm -f .tsuku-exit-code
                else
                  EXIT_CODE=1
                fi

                if [ "$EXIT_CODE" = "0" ]; then
                  STATUS="pass"
                  break
                elif [ "$EXIT_CODE" = "5" ] && [ "$attempt" -lt 3 ]; then
                  echo "Network error, retrying (attempt $((attempt+1)))..."
                  sleep $((2 ** attempt))
                  continue
                else
                  STATUS="fail"
                  break
                fi
              done

              RESULTS=$(echo "$RESULTS" | jq --arg r "$recipe_name" --arg p "$platform" \
                --arg s "$STATUS" --argjson e "$EXIT_CODE" --argjson a "$ATTEMPTS" \
                '. + [{"recipe": $r, "platform": $p, "status": $s, "exit_code": $e, "attempts": $a}]')
            done
          done

          echo "$RESULTS" > validation-results-linux-arm64.json
          echo "### Linux arm64 Validation Results" >> "$GITHUB_STEP_SUMMARY"
          echo '```json' >> "$GITHUB_STEP_SUMMARY"
          echo "$RESULTS" | jq . >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - uses: actions/upload-artifact@v4
        with:
          name: validation-results-linux-arm64
          path: validation-results-linux-arm64.json
          retention-days: 1

  validate-darwin-arm64:
    needs: generate
    if: needs.generate.outputs.has_recipes == 'true'
    runs-on: macos-14
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: passing-recipes
          path: artifacts

      - uses: actions/download-artifact@v4
        with:
          name: tsuku-binaries

      - name: Make binary executable
        run: chmod +x tsuku-darwin-arm64

      - name: Collect new recipe list
        id: recipes
        run: |
          RECIPE_LIST=""
          for f in artifacts/recipes/*/*.toml; do
            basename_path="${f#artifacts/}"
            if [ ! -f "$basename_path" ]; then
              RECIPE_LIST="$RECIPE_LIST $basename_path"
            fi
          done
          echo "list=$RECIPE_LIST" >> "$GITHUB_OUTPUT"

      - name: Copy new recipes into working tree
        run: cp -r artifacts/recipes/* recipes/

      - name: Validate on macOS arm64
        run: |
          RESULTS="[]"
          for recipe_path in ${{ steps.recipes.outputs.list }}; do
            recipe_name=$(basename "$recipe_path" .toml)

            case "$recipe_path" in
              *..*)
                echo "SKIP: path traversal detected in $recipe_path"
                continue
                ;;
            esac

            echo "--- $recipe_name on darwin-arm64 ---"
            STATUS="pass"
            EXIT_CODE=0
            ATTEMPTS=1

            for attempt in 1 2 3; do
              ATTEMPTS=$attempt
              if timeout 300 ./tsuku-darwin-arm64 install --force --recipe "$recipe_path" 2>&1; then
                EXIT_CODE=0
                STATUS="pass"
                break
              else
                EXIT_CODE=$?
                if [ "$EXIT_CODE" = "5" ] && [ "$attempt" -lt 3 ]; then
                  echo "Network error, retrying (attempt $((attempt+1)))..."
                  sleep $((2 ** attempt))
                  continue
                fi
                STATUS="fail"
                break
              fi
            done

            RESULTS=$(echo "$RESULTS" | jq --arg r "$recipe_name" --arg p "darwin-arm64" \
              --arg s "$STATUS" --argjson e "$EXIT_CODE" --argjson a "$ATTEMPTS" \
              '. + [{"recipe": $r, "platform": $p, "status": $s, "exit_code": $e, "attempts": $a}]')
          done

          echo "$RESULTS" > validation-results-darwin-arm64.json
          echo "### macOS arm64 Validation Results" >> "$GITHUB_STEP_SUMMARY"
          echo '```json' >> "$GITHUB_STEP_SUMMARY"
          echo "$RESULTS" | jq . >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - uses: actions/upload-artifact@v4
        with:
          name: validation-results-darwin-arm64
          path: validation-results-darwin-arm64.json
          retention-days: 1

  validate-darwin-x86_64:
    needs: generate
    if: needs.generate.outputs.has_recipes == 'true'
    runs-on: macos-13
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: passing-recipes
          path: artifacts

      - uses: actions/download-artifact@v4
        with:
          name: tsuku-binaries

      - name: Make binary executable
        run: chmod +x tsuku-darwin-amd64

      - name: Collect new recipe list
        id: recipes
        run: |
          RECIPE_LIST=""
          for f in artifacts/recipes/*/*.toml; do
            basename_path="${f#artifacts/}"
            if [ ! -f "$basename_path" ]; then
              RECIPE_LIST="$RECIPE_LIST $basename_path"
            fi
          done
          echo "list=$RECIPE_LIST" >> "$GITHUB_OUTPUT"

      - name: Copy new recipes into working tree
        run: cp -r artifacts/recipes/* recipes/

      - name: Validate on macOS x86_64
        run: |
          RESULTS="[]"
          for recipe_path in ${{ steps.recipes.outputs.list }}; do
            recipe_name=$(basename "$recipe_path" .toml)

            case "$recipe_path" in
              *..*)
                echo "SKIP: path traversal detected in $recipe_path"
                continue
                ;;
            esac

            echo "--- $recipe_name on darwin-x86_64 ---"
            STATUS="pass"
            EXIT_CODE=0
            ATTEMPTS=1

            for attempt in 1 2 3; do
              ATTEMPTS=$attempt
              if timeout 300 ./tsuku-darwin-amd64 install --force --recipe "$recipe_path" 2>&1; then
                EXIT_CODE=0
                STATUS="pass"
                break
              else
                EXIT_CODE=$?
                if [ "$EXIT_CODE" = "5" ] && [ "$attempt" -lt 3 ]; then
                  echo "Network error, retrying (attempt $((attempt+1)))..."
                  sleep $((2 ** attempt))
                  continue
                fi
                STATUS="fail"
                break
              fi
            done

            RESULTS=$(echo "$RESULTS" | jq --arg r "$recipe_name" --arg p "darwin-x86_64" \
              --arg s "$STATUS" --argjson e "$EXIT_CODE" --argjson a "$ATTEMPTS" \
              '. + [{"recipe": $r, "platform": $p, "status": $s, "exit_code": $e, "attempts": $a}]')
          done

          echo "$RESULTS" > validation-results-darwin-x86_64.json
          echo "### macOS x86_64 Validation Results" >> "$GITHUB_STEP_SUMMARY"
          echo '```json' >> "$GITHUB_STEP_SUMMARY"
          echo "$RESULTS" | jq . >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - uses: actions/upload-artifact@v4
        with:
          name: validation-results-darwin-x86_64
          path: validation-results-darwin-x86_64.json
          retention-days: 1

  merge:
    needs: [generate, validate-linux-x86_64, validate-linux-arm64, validate-darwin-arm64, validate-darwin-x86_64]
    if: always() && needs.generate.outputs.has_recipes == 'true' && needs.generate.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: passing-recipes
          path: artifacts

      - name: Download validation results (tolerating missing artifacts)
        run: |
          # Download each result artifact, creating empty results for failed/skipped jobs
          for platform in linux-x86_64 linux-arm64 darwin-arm64 darwin-x86_64; do
            echo "[]" > "validation-results-${platform}.json"
          done

      - uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: validation-results-linux-x86_64

      - uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: validation-results-linux-arm64

      - uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: validation-results-darwin-arm64

      - uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: validation-results-darwin-x86_64

      - name: Copy new recipes into working tree
        run: cp -r artifacts/recipes/* recipes/

      - name: Copy data files
        run: |
          if [ -d artifacts/data ]; then
            cp -r artifacts/data/* data/
          fi

      - name: Aggregate results and write constraints
        run: |
          # Merge all validation results
          jq -s 'add' \
            validation-results-linux-x86_64.json \
            validation-results-linux-arm64.json \
            validation-results-darwin-arm64.json \
            validation-results-darwin-x86_64.json \
            > all-results.json

          echo "### Aggregated Results" >> "$GITHUB_STEP_SUMMARY"

          # Get unique recipe names
          RECIPES=$(jq -r '.[].recipe' all-results.json | sort -u)

          for recipe in $RECIPES; do
            echo "=== Processing $recipe ==="

            # Check for run_command action (security gate)
            RECIPE_FILE=$(find recipes -name "${recipe}.toml" | head -1)
            if grep -q 'action.*=.*"run_command"' "$RECIPE_FILE" 2>/dev/null; then
              echo "EXCLUDE: $recipe has run_command action"
              rm -f "$RECIPE_FILE"
              continue
            fi

            # Get per-platform results for this recipe
            TOTAL=$(jq --arg r "$recipe" '[.[] | select(.recipe == $r)] | length' all-results.json)
            PASSED=$(jq --arg r "$recipe" '[.[] | select(.recipe == $r and .status == "pass")] | length' all-results.json)
            FAILED_PLATFORMS=$(jq -r --arg r "$recipe" '[.[] | select(.recipe == $r and .status == "fail")] | .[].platform' all-results.json)

            echo "$recipe: $PASSED/$TOTAL passed"

            if [ "$PASSED" = "$TOTAL" ]; then
              echo "All platforms pass, no constraints needed"
              continue
            fi

            if [ "$PASSED" = "0" ]; then
              echo "EXCLUDE: $recipe failed on all platforms"
              rm -f "$RECIPE_FILE"
              continue
            fi

            # Derive constraints
            ./scripts/write-platform-constraints.sh "$RECIPE_FILE" "$recipe" all-results.json
          done

          # Summary
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Recipe | Passed | Total | Constraints |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|--------|-------|-------------|" >> "$GITHUB_STEP_SUMMARY"
          for recipe in $RECIPES; do
            RECIPE_FILE=$(find recipes -name "${recipe}.toml" | head -1)
            if [ -z "$RECIPE_FILE" ]; then
              echo "| $recipe | - | - | Excluded |" >> "$GITHUB_STEP_SUMMARY"
              continue
            fi
            TOTAL=$(jq --arg r "$recipe" '[.[] | select(.recipe == $r)] | length' all-results.json)
            PASSED=$(jq --arg r "$recipe" '[.[] | select(.recipe == $r and .status == "pass")] | length' all-results.json)
            CONSTRAINTS=$(grep -E 'supported_os|supported_libc|unsupported_platforms' "$RECIPE_FILE" 2>/dev/null | head -1 || echo "None")
            echo "| $recipe | $PASSED | $TOTAL | $CONSTRAINTS |" >> "$GITHUB_STEP_SUMMARY"
          done

      - name: Requeue unblocked packages
        run: ./scripts/requeue-unblocked.sh

      - name: Check for recipes to merge
        id: check
        run: |
          if git diff --quiet recipes/ && [ -z "$(git ls-files --others --exclude-standard recipes/)" ]; then
            echo "changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create pull request
        if: steps.check.outputs.changes == 'true'
        run: |
          BRANCH="batch/${{ inputs.ecosystem }}-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH"
          git add recipes/ data/
          git reset HEAD -- data/batch-summary.md 2>/dev/null || true
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "feat(recipes): add batch $(date +%Y-%m-%d) ${{ inputs.ecosystem }} recipes"
          git push -u origin "$BRANCH"
          BODY="Automated batch generation for ${{ inputs.ecosystem }} ecosystem."
          if [ -f data/batch-summary.md ]; then
            BODY=$(cat data/batch-summary.md)
          fi
          gh pr create \
            --title "feat(recipes): add batch ${{ inputs.ecosystem }} recipes" \
            --body "$BODY" \
            --base main
        env:
          GH_TOKEN: ${{ secrets.PAT_BATCH_GENERATE }}
