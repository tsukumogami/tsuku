name: Seed Queue

on:
  schedule:
    - cron: '0 3 * * 0'  # Sunday 03:00 UTC
  workflow_dispatch:
    inputs:
      source:
        description: 'Ecosystem source'
        type: choice
        options:
          - all
          - homebrew
          - cargo
          - npm
          - pypi
          - rubygems
        default: 'all'
      limit:
        description: 'Max packages per source'
        default: '500'

permissions:
  contents: write
  issues: write

concurrency:
  group: queue-operations
  cancel-in-progress: false

jobs:
  seed:
    name: Seed Priority Queue
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Generate token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf  # v2.2.1
        with:
          app-id: ${{ secrets.TSUKU_BATCH_GENERATOR_APP_ID }}
          private-key: ${{ secrets.TSUKU_BATCH_GENERATOR_APP_PRIVATE_KEY }}

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5  # v6.2.0
        with:
          go-version-file: go.mod

      - name: Build seed-queue
        run: go build -o seed-queue ./cmd/seed-queue

      - name: Run seeding
        run: |
          ./seed-queue \
            -source "${{ inputs.source || 'all' }}" \
            -limit "${{ inputs.limit || '500' }}" \
            -queue data/queues/priority-queue.json \
            -recipes-dir recipes \
            -audit-dir data/disambiguations/audit \
            -verbose \
            > seeding-summary.json

      - name: Create source change issues
        if: success()
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          jq -c '.source_changes[] | select(.auto_accepted == false)' \
            seeding-summary.json | while IFS= read -r change; do
              pkg=$(echo "$change" | jq -r '.package')
              # Skip if an open issue already exists for this package
              existing=$(gh issue list --search "review: source change for $pkg" --state open --json number --jq 'length')
              if [ "$existing" -gt 0 ]; then
                echo "Skipping $pkg: open issue already exists"
                continue
              fi
              old=$(echo "$change" | jq -r '.old')
              new=$(echo "$change" | jq -r '.new')
              pri=$(echo "$change" | jq -r '.priority')
              gh issue create \
                --title "review: source change for $pkg" \
                --label "seeding:review" \
                --body "## Source Change Review

          - **Package**: $pkg
          - **Old source**: $old
          - **New source**: $new
          - **Priority**: $pri

          Review the audit log at \`data/disambiguations/audit/$pkg.json\` for probe details."
            done

      - name: Commit and push
        run: |
          git add data/queues/priority-queue.json data/disambiguations/audit/ data/metrics/seeding-runs.jsonl
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "chore(batch): update queue from seeding run"
          for i in 1 2 3; do
            git push && break
            echo "Push failed (attempt $i), rebasing..."
            sleep $((i * 5))
            git pull --rebase
          done
