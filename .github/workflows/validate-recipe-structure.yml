name: Validate Recipe Structure

on:
  push:
    paths:
      - 'internal/recipe/recipes/**'
      - 'recipes/**'
  pull_request:
    paths:
      - 'internal/recipe/recipes/**'
      - 'recipes/**'

jobs:
  validate-structure:
    name: Validate Recipe Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Validate embedded recipes are flat
        run: |
          # Embedded recipes must be directly in internal/recipe/recipes/
          # No subdirectories allowed
          echo "Checking embedded recipes structure..."

          if [ ! -d "internal/recipe/recipes" ]; then
            echo "Embedded recipes directory not found"
            exit 1
          fi

          # Find any subdirectories (excluding . entries)
          subdirs=$(find internal/recipe/recipes -mindepth 1 -maxdepth 1 -type d 2>/dev/null || true)
          if [ -n "$subdirs" ]; then
            echo "::error::Embedded recipes must be in a flat structure (no subdirectories)."
            echo "Found subdirectories:"
            echo "$subdirs"
            echo ""
            echo "Move recipe files directly to internal/recipe/recipes/<name>.toml"
            exit 1
          fi

          # Verify .toml files exist at the root
          toml_count=$(find internal/recipe/recipes -maxdepth 1 -name "*.toml" | wc -l)
          if [ "$toml_count" -eq 0 ]; then
            echo "::error::No embedded recipes found in internal/recipe/recipes/"
            exit 1
          fi

          echo "Found $toml_count embedded recipes in flat structure"

      - name: Validate registry recipes use letter directories
        run: |
          # Registry recipes must be in recipes/<letter>/<name>.toml
          echo "Checking registry recipes structure..."

          if [ ! -d "recipes" ]; then
            echo "Registry recipes directory not found"
            exit 1
          fi

          # Check for .toml files at root level (should not exist)
          root_tomls=$(find recipes -maxdepth 1 -name "*.toml" 2>/dev/null || true)
          if [ -n "$root_tomls" ]; then
            echo "::error::Registry recipes must be in letter subdirectories (recipes/<letter>/<name>.toml)."
            echo "Found .toml files at root level:"
            echo "$root_tomls"
            echo ""
            echo "Move these files to recipes/<first-letter>/<name>.toml"
            exit 1
          fi

          # Verify all subdirectories are single lowercase letters (excluding discovery/)
          invalid_dirs=$(find recipes -mindepth 1 -maxdepth 1 -type d ! -name '[a-z]' ! -name 'discovery' 2>/dev/null || true)
          if [ -n "$invalid_dirs" ]; then
            echo "::error::Registry recipe subdirectories must be single lowercase letters."
            echo "Found invalid directories:"
            echo "$invalid_dirs"
            exit 1
          fi

          # Count recipes in letter directories
          recipe_count=$(find recipes -mindepth 2 -maxdepth 2 -name "*.toml" | wc -l)
          echo "Found $recipe_count registry recipes in letter directories"

      - name: Validate recipes are in correct letter directory
        run: |
          # Each recipe must be in the directory matching its first letter
          # e.g., fzf.toml must be in recipes/f/, not recipes/a/
          echo "Checking recipes are in correct letter directories..."

          misplaced=""
          while IFS= read -r recipe; do
            [ -z "$recipe" ] && continue
            dir_letter=$(basename "$(dirname "$recipe")")
            file_name=$(basename "$recipe" .toml)
            expected_letter="${file_name:0:1}"

            if [ "$dir_letter" != "$expected_letter" ]; then
              misplaced="${misplaced}  ${recipe} -> should be in recipes/${expected_letter}/\n"
            fi
          done < <(find recipes -mindepth 2 -maxdepth 2 -name "*.toml" 2>/dev/null)

          if [ -n "$misplaced" ]; then
            echo "::error::Found recipes in wrong letter directories."
            echo "Misplaced recipes:"
            printf "%b" "$misplaced"
            echo ""
            echo "Move each recipe to recipes/<first-letter-of-name>/<name>.toml"
            exit 1
          fi

          echo "All recipes are in correct letter directories"

      - name: Check for duplicate recipes
        run: |
          # No recipe should exist in both embedded and registry
          echo "Checking for duplicate recipes..."

          # Get embedded recipe names (without path and extension)
          embedded_names=$(find internal/recipe/recipes -maxdepth 1 -name "*.toml" -exec basename {} .toml \; | sort)

          # Get registry recipe names
          registry_names=$(find recipes -mindepth 2 -maxdepth 2 -name "*.toml" -exec basename {} .toml \; | sort)

          # Find duplicates
          duplicates=$(comm -12 <(echo "$embedded_names") <(echo "$registry_names"))

          if [ -n "$duplicates" ]; then
            echo "::error::Found recipes that exist in both embedded and registry locations."
            echo "Duplicate recipes:"
            echo "$duplicates"
            echo ""
            echo "Each recipe must exist in only one location:"
            echo "  - Embedded (compiled into binary): internal/recipe/recipes/<name>.toml"
            echo "  - Registry (fetched at runtime): recipes/<letter>/<name>.toml"
            exit 1
          fi

          echo "No duplicate recipes found"
          echo ""
          echo "Summary:"
          echo "  Embedded recipes: $(echo "$embedded_names" | wc -w)"
          echo "  Registry recipes: $(echo "$registry_names" | wc -w)"

  validate-coverage:
    name: Validate Libc Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5  # v6.2.0
        with:
          go-version: '1.22'
          cache: true

      - name: Build tsuku
        run: go build -o tsuku ./cmd/tsuku

      - name: Check libc coverage for embedded recipes
        run: |
          echo "Checking libc coverage for embedded library recipes..."
          echo ""

          # Track overall status
          has_errors=false
          has_warnings=false

          # Check each embedded recipe
          for recipe in internal/recipe/recipes/*.toml; do
            output=$(./tsuku validate --check-libc-coverage --json "$recipe" 2>/dev/null || true)

            # Parse JSON for errors/warnings
            errors=$(echo "$output" | jq -r '.errors[]?.message // empty' 2>/dev/null || true)
            warnings=$(echo "$output" | jq -r '.warnings[]?.message // empty' 2>/dev/null || true)

            name=$(basename "$recipe" .toml)

            if [ -n "$errors" ]; then
              echo "::error file=$recipe::$name: $errors"
              has_errors=true
            fi

            if [ -n "$warnings" ]; then
              # Warnings are informational, not blocking
              echo "::warning file=$recipe::$name: $warnings"
              has_warnings=true
            fi
          done

          if [ "$has_errors" = true ]; then
            echo ""
            echo "::error::Library recipes must have musl support or explicit supported_libc constraint."
            echo ""
            echo "To fix, either:"
            echo "  1. Add a musl step: [[steps]] action = \"apk_install\" packages = [\"...\"] when = { os = [\"linux\"], libc = [\"musl\"] }"
            echo "  2. Add explicit constraint: supported_libc = [\"glibc\"] with unsupported_reason"
            echo ""
            echo "See docs/GUIDE-hybrid-libc-recipes.md for details."
            exit 1
          fi

          if [ "$has_warnings" = true ]; then
            echo ""
            echo "Some recipes have missing musl coverage (warnings only, not blocking)."
            echo "Consider adding musl support for better Alpine compatibility."
          fi

          echo ""
          echo "Libc coverage validation passed."
