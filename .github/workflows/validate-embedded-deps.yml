name: Validate Embedded Dependencies

on:
  push:
    paths:
      - 'internal/recipe/recipes/**'
      - 'recipes/**'
      - 'internal/actions/**'
      - 'internal/recipe/loader.go'
      - 'embedded-validation-exclusions.json'
  pull_request:
    paths:
      - 'internal/recipe/recipes/**'
      - 'recipes/**'
      - 'internal/actions/**'
      - 'internal/recipe/loader.go'
      - 'embedded-validation-exclusions.json'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build tsuku
        run: go build -o tsuku ./cmd/tsuku

      - name: Validate embedded action dependencies
        run: |
          set +e  # Don't exit on error - we handle failures ourselves

          # Test recipes that exercise each action type
          # Format: action:recipe:location where location is "embedded" or "registry"
          # Embedded recipes are at internal/recipe/recipes/<letter>/<name>.toml
          # Registry recipes are at recipes/<letter>/<name>.toml
          test_recipes=(
            "go_install:gofumpt:registry"
            "cargo_install:cargo-audit:registry"
            "npm_install:netlify-cli:registry"
            "pipx_install:ruff:registry"
            "gem_install:bundler:registry"
            "cpan_install:ack:registry"
            "homebrew:make:embedded"
          )

          # Load exclusions
          if [ -f embedded-validation-exclusions.json ]; then
            exclusions=$(jq -r '.exclusions[].recipe // empty' embedded-validation-exclusions.json 2>/dev/null || echo "")
          else
            exclusions=""
          fi

          failed=0
          passed=0
          skipped=0

          echo "=== Embedded Dependency Validation ==="
          echo ""

          for entry in "${test_recipes[@]}"; do
            IFS=':' read -r action recipe location <<< "$entry"
            first_letter="${recipe:0:1}"

            # Check if excluded
            if echo "$exclusions" | grep -q "^${recipe}$"; then
              echo "SKIP: $recipe (excluded)"
              skipped=$((skipped + 1))
              continue
            fi

            # Determine recipe path based on location
            if [ "$location" = "embedded" ]; then
              recipe_path="internal/recipe/recipes/${first_letter}/${recipe}.toml"
            else
              recipe_path="recipes/${first_letter}/${recipe}.toml"
            fi

            # Verify recipe file exists
            if [ ! -f "$recipe_path" ]; then
              echo "FAIL: $recipe ($action) - recipe file not found at $recipe_path"
              failed=$((failed + 1))
              continue
            fi

            echo -n "TEST: $recipe ($action)... "
            output=$(./tsuku eval --recipe "$recipe_path" --require-embedded --install-deps 2>&1)
            exit_code=$?
            if [ $exit_code -eq 0 ]; then
              echo "PASS"
              passed=$((passed + 1))
            else
              echo "FAIL"
              echo "  Exit code: $exit_code"
              echo "  Output (last 5 lines):"
              echo "$output" | tail -5 | sed 's/^/    /'
              failed=$((failed + 1))
            fi
          done

          echo ""
          echo "=== Summary ==="
          echo "Passed: $passed"
          echo "Failed: $failed"
          echo "Skipped: $skipped"

          if [ $failed -gt 0 ]; then
            echo ""
            echo "ERROR: $failed recipe(s) failed embedded dependency validation."
            echo "Ensure all action dependencies are in internal/recipe/recipes/"
            exit 1
          fi

          echo ""
          echo "All non-excluded recipes passed embedded dependency validation."
