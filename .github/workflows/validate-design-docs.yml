name: Validate Design Docs
on:
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for grandfathering based on file creation date

      - name: Find all design docs
        id: find
        run: |
          # Find all DESIGN-*.md files anywhere in the repo
          FILES=$(find . -name 'DESIGN-*.md' -type f | sed 's|^\./||' | sort)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ -n "$FILES" ]; then
            echo "Found design docs:"
            echo "$FILES"
          else
            echo "No DESIGN-*.md files found"
          fi

      - name: Validate design docs
        if: steps.find.outputs.files != ''
        run: |
          FAILED=0
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            if ! .github/scripts/validate-design-doc.sh -q "$file"; then
              FAILED=1
            fi
          done <<< "${{ steps.find.outputs.files }}"

          if [ "$FAILED" -eq 1 ]; then
            echo "One or more design docs failed validation"
            exit 1
          fi
          echo "All design docs valid"
