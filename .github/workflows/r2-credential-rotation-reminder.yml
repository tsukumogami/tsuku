# R2 Credential Rotation Reminder
#
# Creates a quarterly reminder issue for R2 token rotation.
# Also serves as continuous validation of GitHub Actions issue creation.
#
# Schedule: Quarterly (Jan 1, Apr 1, Jul 1, Oct 1) at 9 AM UTC
#
# See docs/r2-golden-storage-runbook.md for rotation procedure.
name: R2 Credential Rotation Reminder

on:
  schedule:
    # Quarterly: Jan 1, Apr 1, Jul 1, Oct 1 at 9 AM UTC
    - cron: '0 9 1 1,4,7,10 *'

  workflow_dispatch:
    inputs:
      quarter:
        description: 'Quarter label (e.g., Q1 2026)'
        type: string
        required: false

concurrency:
  group: r2-credential-rotation-reminder
  cancel-in-progress: false

permissions:
  contents: read
  issues: write

jobs:
  create-reminder:
    name: Create Rotation Reminder
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Determine quarter
        id: quarter
        run: |
          if [ -n "${{ inputs.quarter }}" ]; then
            QUARTER="${{ inputs.quarter }}"
          else
            MONTH=$(date +%-m)
            YEAR=$(date +%Y)
            if [ "$MONTH" -le 3 ]; then
              QUARTER="Q1 $YEAR"
            elif [ "$MONTH" -le 6 ]; then
              QUARTER="Q2 $YEAR"
            elif [ "$MONTH" -le 9 ]; then
              QUARTER="Q3 $YEAR"
            else
              QUARTER="Q4 $YEAR"
            fi
          fi
          echo "quarter=$QUARTER" >> $GITHUB_OUTPUT

      - name: Create rotation reminder issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          QUARTER: ${{ steps.quarter.outputs.quarter }}
        run: |
          TITLE="R2 Token Rotation - $QUARTER"

          # Check if issue already exists
          EXISTING=$(gh issue list \
            --search "\"$TITLE\" in:title" \
            --state open \
            --json number \
            --jq '.[0].number // empty')

          if [ -n "$EXISTING" ]; then
            echo "Issue already exists: #$EXISTING"
            exit 0
          fi

          # Ensure label exists
          gh label create "maintenance" --description "Maintenance tasks" --color "0e8a16" 2>/dev/null || true

          BODY="## Quarterly R2 Token Rotation - $QUARTER

          R2 access tokens should be rotated every 90 days. Follow the procedure in the [operational runbook](../docs/r2-golden-storage-runbook.md#rotation-procedure).

          ### Rotation Checklist

          - [ ] Generate new read-only tokens in Cloudflare Dashboard
          - [ ] Generate new read-write tokens in Cloudflare Dashboard
          - [ ] Update GitHub Secrets:
            - [ ] \`R2_ACCESS_KEY_ID_READONLY\`
            - [ ] \`R2_SECRET_ACCESS_KEY_READONLY\`
            - [ ] \`R2_ACCESS_KEY_ID_WRITE\`
            - [ ] \`R2_SECRET_ACCESS_KEY_WRITE\`
          - [ ] Verify read access: \`gh workflow run r2-health-monitor.yml\`
          - [ ] Verify write access: \`gh workflow run r2-cleanup.yml -f dry_run=true\`
          - [ ] Revoke old tokens in Cloudflare Dashboard

          ### Links

          - [Cloudflare R2 Dashboard](https://dash.cloudflare.com/?to=/:account/r2/api-tokens)
          - [GitHub Secrets](https://github.com/${{ github.repository }}/settings/secrets/actions)
          - [Runbook: Credential Management](../docs/r2-golden-storage-runbook.md#credential-management)

          ---
          *This issue was automatically created by the R2 credential rotation reminder workflow.*"

          gh issue create \
            --title "$TITLE" \
            --body "$BODY" \
            --label "maintenance"

          echo "Created rotation reminder issue for $QUARTER"
