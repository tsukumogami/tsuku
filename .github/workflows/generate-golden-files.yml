# Generate golden files across all platforms for a recipe.
#
# This workflow can be triggered:
# 1. Manually via workflow_dispatch (Actions UI)
# 2. Programmatically from other workflows via workflow_call
#
# Family-Aware Recipes:
#   The regenerate-golden.sh script queries recipe metadata to determine if
#   family-specific files are needed. For family-aware recipes (those using
#   apt_install, dnf_install, etc.), the Linux runner generates multiple files:
#   - v1.0.0-linux-debian-amd64.json
#   - v1.0.0-linux-rhel-amd64.json
#   - v1.0.0-linux-arch-amd64.json
#   - v1.0.0-linux-alpine-amd64.json
#   - v1.0.0-linux-suse-amd64.json
#
#   For family-agnostic recipes, a single linux file is generated:
#   - v1.0.0-linux-amd64.json
#
# Note: commit_back only works for branches in this repository, not fork PRs.
#
# See CONTRIBUTING.md "Golden File Testing" section for usage.
name: Generate Golden Files

on:
  workflow_dispatch:
    inputs:
      recipe:
        description: 'Recipe name to regenerate golden files for'
        required: true
        type: string
      commit_back:
        description: 'Commit results back to current branch'
        type: boolean
        default: false
      branch:
        description: 'Branch to run on (defaults to current ref)'
        required: false
        type: string

  workflow_call:
    inputs:
      recipe:
        description: 'Recipe name to regenerate golden files for'
        required: true
        type: string
      commit_back:
        description: 'Commit results back to current branch'
        type: boolean
        default: false
      branch:
        description: 'Branch to run on (defaults to current ref)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  generate:
    name: "${{ matrix.platform.name }}"
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - { runner: ubuntu-latest, name: "Linux x86_64", os: linux, arch: amd64 }
          - { runner: macos-14, name: "macOS Apple Silicon", os: darwin, arch: arm64 }
          - { runner: macos-15-intel, name: "macOS Intel", os: darwin, arch: amd64 }
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          ref: ${{ inputs.branch || github.ref }}

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff  # v5
        with:
          go-version-file: 'go.mod'
          cache-dependency-path: go.sum

      - name: Build tsuku
        run: CGO_ENABLED=0 go build -o tsuku ./cmd/tsuku

      - name: Compute golden path
        id: golden-path
        run: |
          first_letter="${{ inputs.recipe }}"
          first_letter="${first_letter:0:1}"
          echo "recipe_dir=testdata/golden/plans/${first_letter}/${{ inputs.recipe }}" >> "$GITHUB_OUTPUT"

      - name: Generate golden files for ${{ matrix.platform.os }}-${{ matrix.platform.arch }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./scripts/regenerate-golden.sh "${{ inputs.recipe }}" \
            --os "${{ matrix.platform.os }}" \
            --arch "${{ matrix.platform.arch }}"

      - name: Upload golden files
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
        with:
          name: golden-${{ matrix.platform.os }}-${{ matrix.platform.arch }}
          path: ${{ steps.golden-path.outputs.recipe_dir }}
          if-no-files-found: warn

  commit:
    name: Commit Results
    needs: generate
    if: inputs.commit_back
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          ref: ${{ inputs.branch || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Download all artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4
        with:
          path: artifacts/

      - name: Merge golden files
        run: |
          # Compute target directory from recipe name
          first_letter="${{ inputs.recipe }}"
          first_letter="${first_letter:0:1}"
          target_dir="testdata/golden/plans/${first_letter}/${{ inputs.recipe }}"
          mkdir -p "$target_dir"

          # Merge all platform artifacts into the recipe-specific directory.
          # Each artifact contains files for that platform. For family-aware
          # recipes, the linux artifact may contain multiple files (one per
          # family: debian, rhel, arch, alpine, suse). For family-agnostic
          # recipes, the linux artifact contains a single file.
          for dir in artifacts/golden-*/; do
            if [ -d "$dir" ]; then
              echo "Merging from $dir"
              cp -r "$dir"/* "$target_dir/" 2>/dev/null || true
            fi
          done

          # Show what was merged
          echo "Golden files after merge:"
          find "$target_dir" -name "*.json"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add testdata/golden/plans/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(golden): regenerate ${{ inputs.recipe }} golden files"

            # Push with retry logic (3 attempts, exponential backoff)
            for attempt in 1 2 3; do
              if [ $attempt -gt 1 ]; then
                echo "::warning::Push attempt $attempt after failure"
                git pull --rebase || { echo "::error::Rebase failed"; exit 1; }
                sleep $((2 ** attempt))
              fi
              if git push; then
                echo "Push succeeded on attempt $attempt"
                exit 0
              fi
            done
            echo "::error::Push failed after 3 attempts"
            exit 1
          fi
