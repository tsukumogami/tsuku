name: Validate Golden Files (Execution)

on:
  pull_request:
    branches: [main]
    paths:
      - 'testdata/golden/plans/**/*.json'
      - '.github/workflows/validate-golden-execution.yml'
  workflow_dispatch:

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.changed.outputs.has_changes }}
      golden_files: ${{ steps.changed.outputs.golden_files }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed golden files
        id: changed
        run: |
          # Get list of changed golden files (exclude deleted files)
          CHANGED=$(git diff --name-only --diff-filter=d origin/main...HEAD -- 'testdata/golden/plans/**/*.json')

          if [ -z "$CHANGED" ]; then
            echo "No golden files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "golden_files=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed golden files:"
          echo "$CHANGED"

          # Build JSON array of golden file paths
          JSON="["
          FIRST=true
          for path in $CHANGED; do
            # Skip if file doesn't exist (deleted in later commit)
            if [ ! -f "$path" ]; then
              echo "Skipping deleted file: $path"
              continue
            fi

            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              JSON="$JSON,"
            fi
            JSON="$JSON\"$path\""
          done
          JSON="$JSON]"

          if [ "$JSON" = "[]" ]; then
            echo "No golden files to validate"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
          echo "golden_files=$JSON" >> $GITHUB_OUTPUT

  validate-execution:
    name: "Execute: ${{ matrix.platform }}"
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-amd64
          - os: macos-latest
            platform: darwin-arm64
          - os: macos-13
            platform: darwin-amd64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache-dependency-path: go.sum

      - name: Cache downloads
        uses: actions/cache@v4
        with:
          path: ~/.tsuku/cache/downloads
          key: golden-execution-${{ matrix.platform }}-${{ hashFiles('testdata/golden/plans/**/*.json') }}
          restore-keys: |
            golden-execution-${{ matrix.platform }}-
            golden-execution-

      - name: Build tsuku
        run: go build -o tsuku ./cmd/tsuku

      - name: Execute platform-matched golden files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PLATFORM="${{ matrix.platform }}"
          GOLDEN_FILES='${{ needs.detect-changes.outputs.golden_files }}'

          echo "Platform: $PLATFORM"
          echo "Changed golden files: $GOLDEN_FILES"

          # Filter golden files matching this platform
          MATCHED_FILES=$(echo "$GOLDEN_FILES" | jq -r ".[] | select(endswith(\"-${PLATFORM}.json\"))")

          if [ -z "$MATCHED_FILES" ]; then
            echo "No golden files match platform $PLATFORM"
            exit 0
          fi

          echo "Files to execute:"
          echo "$MATCHED_FILES"
          echo ""

          FAILED=0
          for plan in $MATCHED_FILES; do
            echo "::group::Executing: $plan"
            if ./tsuku install --plan "$plan" --force; then
              echo "Success: $plan"
            else
              echo "::error::Failed to execute golden file: $plan"
              FAILED=1
            fi
            echo "::endgroup::"
          done

          if [ $FAILED -ne 0 ]; then
            echo ""
            echo "::error::One or more golden files failed execution validation."
            echo "::error::This may indicate:"
            echo "::error::  - Checksum mismatch (upstream artifact changed)"
            echo "::error::  - Download URL no longer valid"
            echo "::error::  - Installation steps are broken"
            exit 1
          fi

          echo ""
          echo "All platform-matched golden files executed successfully."
