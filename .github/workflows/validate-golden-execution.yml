name: Validate Golden Files (Execution)

on:
  pull_request:
    branches: [main]
    paths:
      - 'testdata/golden/plans/**/*.json'
      - 'scripts/validate-golden.sh'
      - 'scripts/regenerate-golden.sh'
      - '.github/workflows/validate-golden-execution.yml'
  workflow_dispatch:

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}
      has_changes: ${{ steps.build-matrix.outputs.has_changes }}
      recipes: ${{ steps.build-matrix.outputs.recipes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build execution matrix
        id: build-matrix
        run: |
          # Get list of changed golden files (exclude deleted files)
          CHANGED=$(git diff --name-only --diff-filter=d origin/main...HEAD -- 'testdata/golden/plans/**/*.json')

          if [ -z "$CHANGED" ]; then
            echo "No golden files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed golden files:"
          echo "$CHANGED"

          # Build matrix with one entry per file
          # Map platform suffix to runner
          MATRIX='{"include":['
          FIRST=true

          for path in $CHANGED; do
            # Skip if file doesn't exist (deleted in later commit)
            if [ ! -f "$path" ]; then
              echo "Skipping deleted file: $path"
              continue
            fi

            # Extract platform from filename
            # Family-agnostic: v1.20.0-linux-amd64.json -> linux-amd64
            # Family-aware: v1.0.0-linux-debian-amd64.json -> linux-debian-amd64
            filename=$(basename "$path" .json)
            # Check if third-from-last component is a known family
            third_from_last=$(echo "$filename" | rev | cut -d'-' -f3 | rev)
            if [[ "$third_from_last" =~ ^(debian|rhel|arch|alpine|suse)$ ]]; then
              # Family-aware: extract os-family-arch
              platform=$(echo "$filename" | rev | cut -d'-' -f1-3 | rev)
            else
              # Family-agnostic: extract os-arch
              platform=$(echo "$filename" | rev | cut -d'-' -f1-2 | rev)
            fi

            # Map platform to runner
            # Handle both family-agnostic (linux-amd64) and family-aware (linux-debian-amd64)
            case "$platform" in
              linux-amd64|linux-debian-amd64)
                # Ubuntu runners are Debian-based
                os="ubuntu-latest"
                ;;
              linux-rhel-amd64|linux-arch-amd64|linux-alpine-amd64|linux-suse-amd64)
                # Skip: no matching GitHub-hosted runners
                echo "Skipping $path ($platform no matching runner)"
                continue
                ;;
              darwin-arm64)
                os="macos-latest"
                ;;
              darwin-amd64)
                # Skip: Intel Mac runners require paid tier
                echo "Skipping $path (darwin-amd64 requires paid tier)"
                continue
                ;;
              linux-arm64|linux-*-arm64)
                # Skip: no GitHub-hosted runners available
                echo "Skipping $path (linux-arm64 no runners available)"
                continue
                ;;
              *)
                echo "Unknown platform in $path: $platform"
                continue
                ;;
            esac

            # Extract tool name for job naming
            tool=$(basename "$(dirname "$path")")

            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              MATRIX="$MATRIX,"
            fi

            MATRIX="$MATRIX{\"file\":\"$path\",\"os\":\"$os\",\"platform\":\"$platform\",\"tool\":\"$tool\",\"version\":\"$filename\"}"
          done

          MATRIX="$MATRIX]}"

          if [ "$MATRIX" = '{"include":[]}' ]; then
            echo "No executable golden files to validate"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

          echo "Matrix: $MATRIX"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

          # Extract unique recipe names for coverage validation
          RECIPES=$(echo "$CHANGED" | while read -r path; do
            if [ -n "$path" ]; then
              basename "$(dirname "$path")"
            fi
          done | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')

          echo "Affected recipes: $RECIPES"
          echo "recipes=$RECIPES" >> $GITHUB_OUTPUT

  validate-coverage:
    name: "Coverage: ${{ matrix.recipe }}"
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        recipe: ${{ fromJson(needs.detect-changes.outputs.recipes) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache-dependency-path: go.sum

      - name: Build tsuku
        run: go build -o tsuku ./cmd/tsuku

      - name: Validate platform coverage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RECIPE="${{ matrix.recipe }}"
          FIRST_LETTER="${RECIPE:0:1}"
          RECIPE_PATH="internal/recipe/recipes/$FIRST_LETTER/$RECIPE.toml"
          GOLDEN_DIR="testdata/golden/plans/$FIRST_LETTER/$RECIPE"

          # Get supported platforms as JSON objects (preserving linux_family if present)
          # Build platform descriptors (os:arch:family)
          PLATFORMS=""
          while IFS= read -r platform_json; do
            os=$(echo "$platform_json" | jq -r '.os')
            arch=$(echo "$platform_json" | jq -r '.arch')
            family=$(echo "$platform_json" | jq -r '.linux_family // empty')

            # Skip linux-arm64 (no CI runner)
            if [[ "$os" == "linux" && "$arch" == "arm64" ]]; then
              continue
            fi

            PLATFORMS="$PLATFORMS $os:$arch:$family"
          done < <(./tsuku info --recipe "$RECIPE_PATH" --metadata-only --json | jq -c '.supported_platforms[]')
          PLATFORMS=$(echo "$PLATFORMS" | xargs)

          # Get versions from existing golden files
          # Family-aware: v1.0.0-linux-debian-amd64.json -> version before last 3 components
          # Family-agnostic: v0.60.0-linux-amd64.json -> version before last 2 components
          VERSIONS=$(for f in "$GOLDEN_DIR"/*.json; do
            filename=$(basename "$f" .json)
            num_parts=$(echo "$filename" | tr '-' '\n' | wc -l)
            if [[ $num_parts -ge 4 ]]; then
              third_from_last=$(echo "$filename" | rev | cut -d'-' -f3 | rev)
              if [[ "$third_from_last" =~ ^(debian|rhel|arch|alpine|suse)$ ]]; then
                echo "$filename" | rev | cut -d'-' -f4- | rev
              else
                echo "$filename" | rev | cut -d'-' -f3- | rev
              fi
            else
              echo "$filename" | rev | cut -d'-' -f3- | rev
            fi
          done 2>/dev/null | sort -u || true)

          if [ -z "$VERSIONS" ]; then
            echo "No golden files found in $GOLDEN_DIR"
            exit 1
          fi

          # Check all platform/version combinations have files
          MISSING=()
          for version in $VERSIONS; do
            for platform_desc in $PLATFORMS; do
              # Parse platform descriptor (os:arch:family)
              os="${platform_desc%%:*}"
              rest="${platform_desc#*:}"
              arch="${rest%%:*}"
              family="${rest#*:}"

              # Build expected filename
              if [[ -n "$family" ]]; then
                expected_file="${version}-${os}-${family}-${arch}.json"
              else
                expected_file="${version}-${os}-${arch}.json"
              fi

              if [ ! -f "$GOLDEN_DIR/$expected_file" ]; then
                MISSING+=("$GOLDEN_DIR/$expected_file")
              fi
            done
          done

          if [ ${#MISSING[@]} -gt 0 ]; then
            echo "ERROR: Missing golden files for supported platforms:"
            for f in "${MISSING[@]}"; do
              echo "  - $f"
            done
            echo ""
            echo "Generate missing files with:"
            echo "  gh workflow run generate-golden-files.yml -f recipe=$RECIPE -f commit_back=true -f branch=\$(git branch --show-current)"
            exit 1
          fi

          echo "All platforms covered for $RECIPE"

  validate-execution:
    name: "${{ matrix.tool }} (${{ matrix.platform }})"
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache-dependency-path: go.sum

      - name: Cache downloads
        uses: actions/cache@v4
        with:
          path: ~/.tsuku/cache/downloads
          key: golden-execution-${{ matrix.platform }}-${{ hashFiles(matrix.file) }}
          restore-keys: |
            golden-execution-${{ matrix.platform }}-

      - name: Build tsuku
        run: go build -o tsuku ./cmd/tsuku

      - name: Execute golden file
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Executing: ${{ matrix.file }}"
          ./tsuku install --plan "${{ matrix.file }}" --force
