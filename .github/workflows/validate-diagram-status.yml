name: Validate Diagram Status for Closing Issues

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  issues: read
  pull-requests: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract issues closed by this PR
        id: closed-issues
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          # Use existing script to extract closing issues, compact to single line
          ISSUES=$(.github/scripts/extract-closing-issues.sh --pr "$PR_NUMBER" | jq -c '.')
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "Closing issues: $ISSUES"

      - name: Validate diagram status for closed issues
        if: steps.closed-issues.outputs.issues != '[]'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUES='${{ steps.closed-issues.outputs.issues }}'
          FAILED=0

          # Parse JSON array to iterate over issue numbers
          for issue_num in $(echo "$ISSUES" | jq -r '.[]'); do
            echo "Checking issue #$issue_num..."

            # Find all design docs referencing this issue in Implementation Issues section
            # Search both active and current design doc directories
            DOCS=$(grep -l "\[#${issue_num}\]" docs/designs/DESIGN-*.md docs/designs/current/DESIGN-*.md 2>/dev/null || true)

            if [[ -z "$DOCS" ]]; then
              echo "  No design docs reference issue #$issue_num, skipping"
              continue
            fi

            for doc in $DOCS; do
              echo "  Checking $doc..."

              # Skip docs without mermaid diagrams
              if ! grep -q '```mermaid' "$doc"; then
                echo "    No Mermaid diagram in $doc, skipping"
                continue
              fi

              # Verify issue is marked as 'done' in the Mermaid diagram
              if ! .github/scripts/check-issue-status.sh "$doc" "$issue_num" "done"; then
                echo "::error file=$doc::Issue #$issue_num should be marked 'done' in diagram (PR closes this issue)"
                FAILED=1
              fi
            done
          done

          if [[ $FAILED -eq 1 ]]; then
            echo ""
            echo "Some issues being closed are not marked 'done' in their design doc diagrams."
            echo "Update the Mermaid diagram class assignments before merging."
            exit 1
          fi

          echo "All closing issues have correct status in design docs"
