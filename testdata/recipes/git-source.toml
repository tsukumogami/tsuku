# Ground truth recipe for git (source build with complex dependencies)
# Used for testing configure_make action with multiple library dependencies
# Tests: download + extract + setup_build_env + configure_make with libcurl, openssl, zlib, expat

[metadata]
name = "git-source"
description = "Distributed revision control system (source build for testing)"
homepage = "https://git-scm.com/"
dependencies = ["libcurl", "openssl", "zlib", "expat"]

[version]
source = "homebrew"
formula = "git"

[[steps]]
action = "download"
url = "https://mirrors.edge.kernel.org/pub/software/scm/git/git-{version}.tar.xz"

[[steps]]
action = "extract"
archive = "git-{version}.tar.xz"
format = "tar.xz"

[[steps]]
action = "setup_build_env"

[[steps]]
action = "configure_make"
source_dir = "git-{version}"
executables = ["git"]
configure_args = ["--with-curl={libs_dir}/libcurl-{deps.libcurl.version}"]

[[steps]]
action = "set_rpath"
binaries = [".install/bin/git"]
rpath = "$ORIGIN/../lib:{libs_dir}/libcurl-{deps.libcurl.version}/lib:{libs_dir}/openssl-{deps.openssl.version}/lib:{libs_dir}/zlib-{deps.zlib.version}/lib:{libs_dir}/expat-{deps.expat.version}/lib:{libs_dir}/brotli-1.2.0/lib:{libs_dir}/libnghttp2-1.68.0/lib:{libs_dir}/libnghttp3-1.14.0/lib:{libs_dir}/libngtcp2-1.19.0/lib:{libs_dir}/libssh2-1.11.1/lib:{libs_dir}/zstd-1.5.7/lib"

[[steps]]
action = "set_rpath"
binaries = [".install/libexec/git-core/git-remote-https"]
rpath = "$ORIGIN/../../..:$ORIGIN/../../../lib:{libs_dir}/libcurl-{deps.libcurl.version}/lib:{libs_dir}/openssl-{deps.openssl.version}/lib:{libs_dir}/zlib-{deps.zlib.version}/lib:{libs_dir}/expat-{deps.expat.version}/lib:{libs_dir}/brotli-1.2.0/lib:{libs_dir}/libnghttp2-1.68.0/lib:{libs_dir}/libnghttp3-1.14.0/lib:{libs_dir}/libngtcp2-1.19.0/lib:{libs_dir}/libssh2-1.11.1/lib:{libs_dir}/zstd-1.5.7/lib"

[[steps]]
action = "install_binaries"
install_mode = "directory"
binaries = ["bin/git"]

[verify]
command = "git --version"
pattern = "git version {version}"
