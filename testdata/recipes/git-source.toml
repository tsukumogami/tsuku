# Ground truth recipe for git (source build with complex dependencies)
# Used for testing configure_make action with multiple library dependencies
# Tests: download + extract + setup_build_env + configure_make with libcurl, openssl, zlib, expat

[metadata]
name = "git-source"
description = "Distributed revision control system (source build for testing)"
homepage = "https://git-scm.com/"
# Include libcurl's transitive dependencies so linker can resolve symbols
# libcurl.so has undefined references to nghttp3, ngtcp2, etc. that need LDFLAGS
dependencies = ["libcurl", "brotli", "libnghttp2", "libnghttp3", "libngtcp2", "libssh2", "openssl", "zlib", "zstd", "expat"]

[version]
source = "homebrew"
formula = "git"

[[steps]]
action = "download"
url = "https://mirrors.edge.kernel.org/pub/software/scm/git/git-{version}.tar.xz"

[[steps]]
action = "extract"
archive = "git-{version}.tar.xz"
format = "tar.xz"

[[steps]]
action = "setup_build_env"

[[steps]]
action = "configure_make"
source_dir = "git-{version}"
executables = ["git"]
skip_configure = true
make_args = [
    "RUNTIME_PREFIX=YesPlease",
    "gitexecdir=libexec/git-core",
    "NO_CURL=",
    "CURLDIR={libs_dir}/libcurl-{deps.libcurl.version}",
    "CURL_LIBCURL=-L{libs_dir}/libcurl-{deps.libcurl.version}/lib -lcurl -L{libs_dir}/libnghttp3-{deps.libnghttp3.version}/lib -lnghttp3 -L{libs_dir}/libngtcp2-{deps.libngtcp2.version}/lib -lngtcp2 -L{libs_dir}/libnghttp2-{deps.libnghttp2.version}/lib -lnghttp2 -L{libs_dir}/libssh2-{deps.libssh2.version}/lib -lssh2 -L{libs_dir}/brotli-{deps.brotli.version}/lib -lbrotlidec -lbrotlicommon -L{libs_dir}/zstd-{deps.zstd.version}/lib -lzstd"
]

[[steps]]
action = "install_binaries"
install_mode = "directory"
binaries = ["bin/git"]

[verify]
command = "git --version"
pattern = "git version {version}"
