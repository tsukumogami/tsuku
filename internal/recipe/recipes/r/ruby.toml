# Ruby - Dynamic programming language
# Official site: https://www.ruby-lang.org/
# Uses prebuilt binaries from ruby/ruby-builder (GitHub Actions team)
# Depends on libyaml library for YAML support

[metadata]
name = "ruby"
description = "Ruby programming language (execution dependency for gem-based tools)"
homepage = "https://www.ruby-lang.org/"
version_format = "semver"
dependencies = ["libyaml"]

[version]
github_repo = "ruby/ruby-builder"
tag_prefix = "ruby-"

# Step 1: Download Ruby
[[steps]]
action = "download"
url = "https://github.com/ruby/ruby-builder/releases/download/ruby-{version}/ruby-{version}-{os}-{arch}.tar.gz"
skip_verification_reason = "ruby-builder releases don't include checksum files"
os_mapping = { linux = "ubuntu-22.04", darwin = "darwin" }
arch_mapping = { amd64 = "x64", arm64 = "arm64" }

# Step 2: Extract Ruby archive
[[steps]]
action = "extract"
archive = "ruby-{version}-{os}-{arch}.tar.gz"
format = "tar.gz"
strip_dirs = 1
os_mapping = { linux = "ubuntu-22.04", darwin = "darwin" }
arch_mapping = { amd64 = "x64", arm64 = "arm64" }

# Step 3: Link libyaml library from shared libs
[[steps]]
action = "link_dependencies"
library = "libyaml"

# Step 3: Create wrapper for ruby binary
[[steps]]
action = "run_command"
command = '''
mv bin/ruby bin/ruby.real
cat > bin/ruby << 'WRAPPER'
#!/bin/bash
# Resolve symlinks to get the real script location
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ $SCRIPT_PATH != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"
INSTALL_DIR="$(dirname "$SCRIPT_DIR")"

# Set library paths for dynamically linked Ruby (includes bundled libyaml)
if [[ "$OSTYPE" == "darwin"* ]]; then
    export DYLD_LIBRARY_PATH="$INSTALL_DIR/lib${DYLD_LIBRARY_PATH:+:$DYLD_LIBRARY_PATH}"
else
    export LD_LIBRARY_PATH="$INSTALL_DIR/lib${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"
fi

# Dynamically detect Ruby version from lib/ruby directory
RUBY_VERSION=$(ls -1 "$INSTALL_DIR/lib/ruby" 2>/dev/null | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
if [ -z "$RUBY_VERSION" ]; then
    RUBY_VERSION=$("$INSTALL_DIR/bin/ruby.real" -e 'puts RUBY_VERSION' 2>/dev/null || echo "3.4.0")
fi

# Detect architecture for platform-specific paths
if [[ "$OSTYPE" == "darwin"* ]]; then
    ARCH=$(uname -m)
    if [ "$ARCH" = "arm64" ]; then
        RUBY_ARCH="arm64-darwin"
    else
        RUBY_ARCH="x86_64-darwin"
    fi
    # Find the exact darwin version directory
    DARWIN_DIR=$(ls -1 "$INSTALL_DIR/lib/ruby/$RUBY_VERSION" 2>/dev/null | grep -E "darwin" | head -1)
    if [ -n "$DARWIN_DIR" ]; then
        RUBY_ARCH="$DARWIN_DIR"
    fi
else
    ARCH=$(uname -m)
    case "$ARCH" in
        x86_64) RUBY_ARCH="x86_64-linux" ;;
        aarch64) RUBY_ARCH="aarch64-linux" ;;
        *) RUBY_ARCH="$ARCH-linux" ;;
    esac
fi

# Set Ruby library paths (override hardcoded paths from build)
export RUBYLIB="$INSTALL_DIR/lib/ruby/site_ruby/$RUBY_VERSION:$INSTALL_DIR/lib/ruby/site_ruby/$RUBY_VERSION/$RUBY_ARCH:$INSTALL_DIR/lib/ruby/site_ruby:$INSTALL_DIR/lib/ruby/vendor_ruby/$RUBY_VERSION:$INSTALL_DIR/lib/ruby/vendor_ruby/$RUBY_VERSION/$RUBY_ARCH:$INSTALL_DIR/lib/ruby/vendor_ruby:$INSTALL_DIR/lib/ruby/$RUBY_VERSION:$INSTALL_DIR/lib/ruby/$RUBY_VERSION/$RUBY_ARCH${RUBYLIB:+:$RUBYLIB}"

# Set GEM paths
export GEM_HOME="$INSTALL_DIR/lib/ruby/gems/$RUBY_VERSION"
export GEM_PATH="$GEM_HOME${GEM_PATH:+:$GEM_PATH}"

exec "$INSTALL_DIR/bin/ruby.real" "$@"
WRAPPER
chmod +x bin/ruby

# Convert Ruby scripts to bash wrappers that call ruby with the script
for script in gem irb erb bundle bundler rake rdoc ri; do
    if [ -f "bin/$script" ]; then
        mv "bin/$script" "bin/$script.rb"
        cat > "bin/$script" << 'SCRIPTWRAPPER'
#!/bin/bash
# Resolve symlinks to get the real script location
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
    DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ $SCRIPT_PATH != /* ]] && SCRIPT_PATH="$DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"
SCRIPT_NAME="$(basename "$SCRIPT_PATH")"
exec "$SCRIPT_DIR/ruby" "$SCRIPT_DIR/${SCRIPT_NAME}.rb" "$@"
SCRIPTWRAPPER
        chmod +x "bin/$script"
    fi
done
'''
description = "Creating wrapper for ruby and converting Ruby scripts"

# Step 4: Register binaries for symlinking
[[steps]]
action = "install_binaries"
outputs = ["bin/ruby", "bin/gem", "bin/bundle", "bin/bundler", "bin/irb", "bin/erb"]
install_mode = "directory"

[verify]
command = "{install_dir}/bin/ruby --version"
pattern = "ruby {version}"
