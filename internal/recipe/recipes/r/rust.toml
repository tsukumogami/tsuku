# Rust - Systems programming language
# Official site: https://www.rust-lang.org/
# NOTE: Uses GitHub for version detection, downloads from static.rust-lang.org

[metadata]
name = "rust"
description = "Rust programming language toolchain (execution dependency for cargo-based tools)"
homepage = "https://www.rust-lang.org/"
version_format = "semver"

[version]
github_repo = "rust-lang/rust"  # Detect version from GitHub releases

# Step 1: Download the archive
[[steps]]
action = "download"
url = "https://static.rust-lang.org/dist/rust-{version}-{arch}-{os}.tar.gz"
os_mapping = { linux = "unknown-linux-gnu", darwin = "apple-darwin" }
arch_mapping = { amd64 = "x86_64", arm64 = "aarch64" }

# Step 2: Extract the archive
[[steps]]
action = "extract"
archive = "rust-{version}-{arch}-{os}.tar.gz"
format = "tar.gz"
strip_dirs = 1
os_mapping = { linux = "unknown-linux-gnu", darwin = "apple-darwin" }
arch_mapping = { amd64 = "x86_64", arm64 = "aarch64" }

# Step 3: Run the official installer with custom prefix
# This properly sets up the sysroot with standard library
[[steps]]
action = "run_command"
command = "./install.sh --prefix={install_dir} --disable-ldconfig"
description = "Running Rust installer to set up toolchain"

# Step 4: Register binaries for symlinking
[[steps]]
action = "install_binaries"
binaries = ["bin/cargo", "bin/rustc", "bin/rustdoc", "bin/rustfmt", "bin/cargo-clippy", "bin/clippy-driver", "bin/rust-analyzer"]
install_mode = "directory"

[verify]
command = "{install_dir}/bin/cargo --version"
pattern = "cargo {version}"
